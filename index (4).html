<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Digital Notes 2026</title>
  <link rel="icon" type="image/png" href="logodn.index.png" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --pink:#ffb6cc; 
      --bg1:#ffdce5; 
      --bg2:#ffe9c7; 
      --accent:#c36b85; 
      --text:#222;
      --heading:#111;
      --card-bg:#ffffff;
      --panel-bg:#ffffff;
      --panel-text:#222;
      --muted:#6b4350;
      --border:#eee;
      --input-bg:#ffffff;
      --nav-bg:linear-gradient(90deg,#ffeef6,#fff6ee);
      --add-cover-bg:rgba(255,255,255,0.6);
    }
    [data-theme="dark"]{
      --bg1:#1a1a1a;
      --bg2:#302b2b;
      --text:#f5f5f5;
      --heading:#ffffff;
      --pink:#8b5b67;
      --accent:#c36b85;
      --card-bg:#262626;
      --panel-bg:#1f1f1f;
      --panel-text:#f5f5f5;
      --muted:#c8a5b1;
      --border:#3a3a3a;
      --input-bg:#262626;
      --nav-bg:#2b2b2b;
      --add-cover-bg:#2b2b2b;
    }

    *{box-sizing:border-box}

    body{
      margin:0;
      font-family:Inter, system-ui, Arial, sans-serif;
      background:linear-gradient(135deg,var(--bg1),var(--bg2));
      min-height:100vh;
      color:var(--text);
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:16px 20px;
      background:linear-gradient(90deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03));
      backdrop-filter:blur(6px);
      flex-wrap:wrap;
    }

    .logo-area{
      display:flex;
      align-items:center;
      gap:12px
    }

    .logo-img{
      width:44px;height:44px;
      object-fit:contain;
      border-radius:10px
    }

    .logo-text{
      font-family:Georgia, serif;
      font-size:24px;
      color:#fff
    }

    .nav-right{
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
    }

    .nav-links a{
      color:var(--muted);
      text-decoration:none;
      padding:8px 12px;
      border-radius:12px;
      background:var(--nav-bg);
      font-weight:700
    }

    input.search{
      padding:8px 12px;
      border-radius:20px;
      border:0;
      min-width:140px;
      background:var(--input-bg);
      color:var(--text)
    }

    main{padding:18px 20px}

    h1.section{
      color:var(--heading);
      margin:18px 0
    }

    .controls{
      display:flex;
      gap:12px;
      align-items:center;
      margin-bottom:12px
    }

    .controls select{
      padding:6px 8px;
      border-radius:8px;
      border:1px solid var(--border);
      background:var(--input-bg);
      color:var(--text)
    }

    .btn{
      background:var(--pink);
      border:none;
      padding:10px 14px;
      border-radius:22px;
      cursor:pointer;
      color:#5a3d4b;
      font-weight:700;
      box-shadow:0 6px 18px rgba(195,107,133,0.12);
      transition:transform .15s ease, box-shadow .2s ease
    }

    .btn:hover{
      transform:translateY(-3px)
    }

    .btn:active,
    .toolbar button:active,
    .icon-btn:active{
      transform:scale(0.95);
    }

    .tap-anim{
      animation:tapPop 320ms ease;
    }

    @keyframes tapPop{
      0%{ transform:scale(1); }
      45%{ transform:scale(0.92); }
      100%{ transform:scale(1); }
    }

    .notes-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(320px,1fr));
      gap:18px
    }

    .note-card{
      padding:16px;
      border-radius:14px;
      min-height:130px;
      box-shadow:0 8px 20px rgba(0,0,0,0.08);
      position:relative;
      overflow:hidden;
      background:var(--card-bg);
      color:var(--panel-text)
    }

    .note-title{
      font-weight:700;
      margin-bottom:8px
    }

    .note-body{
      white-space:pre-wrap;
      color:inherit
    }

    .note-body.preview{
      display:-webkit-box;
      -webkit-line-clamp:3;
      -webkit-box-orient:vertical;
      overflow:hidden;
      text-overflow:ellipsis;
      word-break:break-word;
    }

    .note-thumb{
      width:100%;
      height:140px;
      object-fit:cover;
      border-radius:10px;
      margin:8px 0 10px;
      border:1px solid rgba(0,0,0,0.08)
    }

    .note-thumb.small{
      width:100%;
      height:90px;
      object-fit:cover;
      margin:10px 0;
      display:block;
      padding:0;
      background:transparent;
      cursor:zoom-in;
    }

    .note-meta{
      font-size:12px;
      color:var(--muted)
    }

    .notebooks{
      display:flex;
      gap:18px;
      flex-wrap:wrap
    }

    .notebook{
      width:150px;
      text-align:center;
      position:relative;
      border-radius:12px;
      transition:transform .2s ease, box-shadow .2s ease;
    }

    .notebook:hover{
      transform:translateY(-6px) scale(1.02);
    }

    .notebook.active-lift{
      transform:translateY(-14px) scale(1.03);
    }

    .notebook img{
      width:150px;
      height:200px;
      object-fit:cover;
      border-radius:12px;
      display:block;
      box-shadow:0 10px 22px rgba(0,0,0,0.16)
    }

    .notebook img,
    .notebook p{
      cursor:pointer;
    }

    .notebook p{
      margin:8px 0 0;
      font-weight:700;
      color:var(--text)
    }

    .notebook .dots{
      position:absolute;
      top:8px;
      right:8px;
      cursor:pointer;
      color:var(--text);
      font-size:22px;
      z-index:50
    }

    .notebook .menu{
      display:none;
      position:absolute;
      top:36px;
      right:8px;
      background:var(--panel-bg);
      padding:8px;
      border-radius:10px;
      box-shadow:0 12px 30px rgba(0,0,0,0.12);
      z-index:60
    }

    .notebook .menu button{
      display:block;
      width:160px;
      text-align:left;
      padding:10px;
      border-radius:8px;
      border:none;
      background:linear-gradient(90deg,var(--pink),#ffd0e6);
      color:#5a3d4b;
      font-weight:700;
      margin-bottom:6px;
      cursor:pointer
    }

    .add-cover{
      width:150px;
      height:200px;
      border-radius:12px;
      background:var(--add-cover-bg);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:48px;
      color:var(--muted)
    }

    .overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.4);
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:100
    }

    .modal{
      background:var(--panel-bg);
      color:var(--panel-text);
      width:100%;
      max-width:960px;
      border-radius:12px;
      padding:18px;
      box-shadow:0 18px 40px rgba(0,0,0,0.25)
    }

    .title-input{
      width:100%;
      padding:10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--input-bg);
      color:var(--panel-text);
      margin-bottom:10px;
      font-weight:700
    }

    .toolbar{
      display:flex;
      gap:8px;
      margin-bottom:8px;
      align-items:center;
      flex-wrap:wrap
    }

    .toolbar button,
    .toolbar select,
    .toolbar input[type="color"]{
      padding:10px;
      border-radius:10px;
      border:2px solid rgba(0,0,0,0.04);
      background:var(--panel-bg);
      color:var(--panel-text);
      cursor:pointer;
      font-weight:700
    }

    .toolbar select{
      min-width:160px
    }

    .toolbar .tool-group{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center
    }

    .toolbar .tool-label{
      font-size:12px;
      font-weight:700;
      color:var(--muted)
    }

    .toolbar .text-color-tool{
      width:44px;
      height:44px;
      border-radius:12px;
      border:2px solid rgba(0,0,0,0.06);
      background:var(--panel-bg);
      font-weight:800;
      font-size:18px;
      color:var(--muted)
    }

    .toolbar .text-color-picker{
      width:44px;
      height:44px;
      padding:0;
      border-radius:12px
    }

    .editor{
      min-height:300px;
      position:relative;
      max-height:min(60vh, 420px);
      border-radius:10px;
      border:1px solid var(--border);
      padding:14px;
      overflow:auto;
      background:var(--panel-bg);
      color:var(--panel-text);
      line-height:1.5
    }

    .editor-shell{
      position:relative
    }

    .editor-scroll{
      position:absolute;
      top:12px;
      right:12px;
      display:flex;
      flex-direction:column;
      gap:8px
    }

    .editor-scroll button{
      width:42px;
      height:42px;
      border-radius:14px;
      border:none;
      background:linear-gradient(180deg,#ffd0e6,#ffb6cc);
      cursor:pointer;
      box-shadow:0 6px 14px rgba(195,107,133,0.2);
      font-size:18px
    }

    .editor[contenteditable]{outline:none}

    .color-panel{
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap
    }

    .color-preview{
      width:40px;
      height:40px;
      border-radius:8px;
      border:1px solid #ddd
    }

    .color-controls{
      display:flex;
      flex-direction:column;
      gap:8px
    }

    .color-controls input[type=range]{width:220px}

    .palette{
      display:flex;
      gap:8px;
      flex-wrap:wrap
    }

    .palette button{
      width:36px;
      height:36px;
      border-radius:8px;
      border:2px solid rgba(0,0,0,0.06);
      cursor:pointer
    }

    .icon-btn{
      width:62px;
      height:62px;
      border-radius:50%;
      background:linear-gradient(180deg,#ffd0e6,#ffb6cc);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:30px;
      box-shadow:0 10px 30px rgba(195,107,133,0.18);
      position:fixed;
      bottom:24px;
      right:24px;
      cursor:pointer;
      z-index:120
    }

    .row{
      display:flex;
      gap:8px;
      align-items:center
    }

    .notebook.drop-target{
      outline:3px dashed rgba(195,107,133,0.35)
    }

    .file-input{display:none}

    .note-img{
      max-width:100%;
      border-radius:8px;
      margin-top:8px;
      cursor:move;
      touch-action:none;
    }

    .note-img.selected{
      outline:2px dashed #d66ba0;
      outline-offset:2px;
    }

    .note-asset-block{
      margin:12px 0;
      padding:10px;
      border:1px dashed var(--border);
      border-radius:12px;
      background:rgba(255,255,255,0.55);
    }

    .note-asset-block figcaption{
      font-size:12px;
      color:var(--muted);
      margin-bottom:8px;
      font-weight:700;
      letter-spacing:.2px;
    }

    .drawing-board{
      display:none;
      margin-bottom:12px;
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
      background:var(--panel-bg);
    }

    .draw-toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      margin-bottom:8px;
    }

    .draw-toolbar input,
    .draw-toolbar select,
    .draw-toolbar button{
      border-radius:10px;
      border:1px solid var(--border);
      padding:8px;
      background:var(--panel-bg);
      color:var(--panel-text);
    }

    #drawCanvas{
      width:100%;
      height:220px;
      border:1px solid var(--border);
      border-radius:10px;
      background:#fff;
      display:block;
      cursor:crosshair;
      touch-action:none;
    }

    .template-gallery{
      display:none;
      margin-top:18px;
      padding:16px;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--panel-bg);
    }

    .template-gallery h3{
      margin:0 0 6px;
    }

    .template-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(160px,1fr));
      gap:12px;
    }

    .template-card{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      background:var(--card-bg);
      cursor:pointer;
    }

    .template-card img{
      width:100%;
      height:180px;
      object-fit:cover;
      border-radius:8px;
      display:block;
      margin-bottom:8px;
    }

    .template-card span{
      font-weight:700;
      color:var(--panel-text);
    }

    .compact-color-palette{
      display:none;
      margin-bottom:10px;
      border:1px solid var(--border);
      border-radius:10px;
      padding:8px;
      background:var(--panel-bg);
    }

    .compact-color-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(28px,1fr));
      gap:6px;
      max-width:260px;
    }

    .compact-color-grid button{
      width:28px;
      height:28px;
      border-radius:7px;
      border:1px solid rgba(0,0,0,0.14);
      cursor:pointer;
    }

    .draw-fullscreen-overlay{
      position:fixed;
      inset:0;
      z-index:220;
      background:rgba(14,10,12,0.95);
      display:none;
      flex-direction:column;
      padding:10px;
    }

    .draw-fullscreen-toolbar{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      margin-bottom:8px;
      color:#fff;
    }

    .draw-fullscreen-toolbar input,
    .draw-fullscreen-toolbar select,
    .draw-fullscreen-toolbar button{
      padding:8px;
      border-radius:10px;
      border:1px solid #5e5860;
      background:#272429;
      color:#fff;
    }

    #drawFullscreenCanvas{
      flex:1;
      width:100%;
      border-radius:12px;
      background:#fff;
      touch-action:none;
      cursor:crosshair;
    }

    .calendar-btn{
      background:var(--pink);
      color:#5a3d4b;
      border:none;
    }


    .btn.saving{
      background:linear-gradient(180deg,#ffb9d6,#ffa6cc);
      box-shadow:0 10px 24px rgba(194,72,126,0.28);
    }

    .btn.saved{
      background:linear-gradient(180deg,#b6f3d1,#93e3b8);
      color:#1d5b3a;
    }

    .calendar-modal{
      max-width:420px;
    }

    .calendar-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
    }

    .calendar-grid{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:6px;
    }

    .calendar-weekday,
    .calendar-day{
      text-align:center;
      border-radius:10px;
      padding:8px 0;
      font-weight:700;
      font-size:12px;
    }

    .calendar-weekday{ color:var(--muted); }

    .calendar-day{
      border:1px solid var(--border);
      background:linear-gradient(180deg,#fff8fd,#ffe9f4);
      cursor:pointer;
    }

    .calendar-day.active{
      background:linear-gradient(180deg,#ffb6d8,#fda7cc);
      color:#6a2546;
      border-color:#f192bf;
    }


    [data-theme="dark"] .calendar-day{
      background:linear-gradient(180deg,#2f2a2e,#262226);
      border-color:#51464d;
      color:#f5f5f5;
    }

    [data-theme="dark"] .calendar-day.active{
      background:linear-gradient(180deg,#a56d82,#8f5f72);
      color:#fff;
      border-color:#bc8ea0;
    }

    .editor-modal{
      max-width:940px;
      max-height:92vh;
      overflow:auto;
      transition:max-width .2s ease;
    }

    .editor-modal.fullscreen{
      width:96vw;
      max-width:96vw;
      height:94vh;
      max-height:94vh;
    }

    .auth-overlay{
      position:fixed;
      inset:0;
      z-index:500;
      background:linear-gradient(135deg,#e8cfd2,#dea5be);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
    }

    .auth-card{
      width:min(92vw,430px);
      background:rgba(219,151,180,0.78);
      border-radius:18px;
      padding:28px;
      color:#fff;
      box-shadow:0 20px 55px rgba(0,0,0,0.2);
    }

    .auth-card h1{font-family:Georgia,serif;text-align:center;margin:0 0 10px;}
    .auth-card p{text-align:center;color:#ffeaf2;}
    .auth-card label{display:block;font-weight:700;font-size:12px;letter-spacing:1px;margin:14px 0 6px;}
    .auth-card input{width:100%;padding:12px;border:1px solid #84606f;border-radius:8px;}
    .auth-card #toggleAuthMode{background:none;border:none;color:#fff;font-weight:700;cursor:pointer;text-decoration:underline;}
    .auth-card #authSubmit{margin-top:20px;width:100%;padding:12px;border:none;border-radius:8px;background:#be7899;color:#fff;font-size:26px;cursor:pointer;}

    .export-import-group{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }

    .toast-msg{
      position:fixed;
      top:18px;
      right:18px;
      z-index:900;
      padding:10px 14px;
      border-radius:12px;
      background:linear-gradient(180deg,#ffd9ea,#ffc3dd);
      color:#6b2b4f;
      font-weight:700;
      box-shadow:0 12px 28px rgba(0,0,0,0.2);
      opacity:0;
      transform:translateY(-8px);
      pointer-events:none;
      transition:opacity .22s ease, transform .22s ease;
    }

    .toast-msg.show{
      opacity:1;
      transform:translateY(0);
    }

    [data-theme="dark"] .toast-msg{
      background:linear-gradient(180deg,#6e4b59,#543846);
      color:#fff;
    }

    body.auth-locked header,
    body.auth-locked main,
    body.auth-locked footer,
    body.auth-locked #fab{
      display:none;
    }

    .image-controls{
      display:none;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
      padding:10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--panel-bg);
      color:var(--panel-text);
      margin:8px 0 12px
    }

    .image-controls label{
      font-size:12px;
      font-weight:700;
      color:var(--muted)
    }

    .image-controls input[type="range"]{
      width:160px
    }

    .image-controls select,
    .image-controls button{
      padding:8px 10px;
      border-radius:8px;
      border:1px solid var(--border);
      background:var(--panel-bg);
      color:var(--panel-text);
      cursor:pointer
    }

    .controls label{
      color:var(--text)
    }

    .modal label{
      color:var(--panel-text)
    }

    .notebook-notes{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(310px,1fr));
      gap:18px;
      margin-top:12px
    }

    .notebook-workspace{
      margin-top:22px;
      padding:18px;
      border-radius:16px;
      border:1px solid var(--border);
      background:var(--panel-bg);
      color:var(--panel-text)
    }

    .notebook-workspace-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      flex-wrap:wrap
    }

    .notebook-workspace-title-wrap{
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .notebook-mode-panel{
      margin-top:18px;
      padding:16px;
      border-radius:14px;
      border:1px solid var(--border);
      background:linear-gradient(135deg,#ffe5f0,#ffd6ea);
    }

    .notebook-mode-panel h4{
      margin:0 0 6px;
      color:var(--heading)
    }

    .notebook-mode-panel p{
      margin:0 0 12px;
      color:var(--muted)
    }

    .notebook-notes .note-card{
      min-height:220px;
      padding:18px;
      border:1px solid rgba(0,0,0,0.06);
      cursor:pointer
    }

    .notebook-notes .note-title{
      font-size:20px;
      margin-bottom:12px
    }

    .notebook-notes .note-body.preview{
      -webkit-line-clamp:5;
      font-size:15px
    }


    .notebook-open-mode-btn{
      position:relative;
      display:inline-flex;
      align-items:center;
      gap:12px;
      padding:11px 18px;
      border-radius:999px;
      border:none;
      font-weight:700;
      color:#6b2b4f;
      background:linear-gradient(180deg,#ffd1e8,#ffb7da);
      box-shadow:0 8px 18px rgba(179,73,123,0.22);
      cursor:pointer;
    }

    .notebook-open-mode-btn .book-icon{
      width:26px;
      height:18px;
      border-radius:4px;
      position:relative;
      display:inline-block;
      background:#fff3fa;
      border:2px solid #b55286;
      box-shadow:inset -7px 0 0 rgba(181,82,134,0.18);
    }

    .notebook-open-mode-btn .book-icon::before{
      content:'';
      position:absolute;
      top:-2px;
      bottom:-2px;
      left:50%;
      width:2px;
      transform:translateX(-50%);
      background:#b55286;
    }

    .book-shell{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:20px;
      margin-top:12px
    }

    .book-stage{
      width:min(950px, 96vw);
      display:flex;
      justify-content:center
    }

    .book-topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      flex-wrap:wrap
    }

    .book-container{
      width:100%;
      min-height:500px;
      perspective:1200px;
      position:relative;
      background:linear-gradient(150deg,#ffcae3,#f7b7d8);
      border-radius:18px;
      padding:28px 20px;
      box-shadow:0 20px 42px rgba(140,48,101,0.32)
    }

    .book-spread{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:0;
      min-height:440px;
      border-radius:14px;
      overflow:hidden;
      box-shadow:0 16px 36px rgba(0,0,0,0.26);
      position:relative;
      transition:transform 0.65s ease;
      transform-style:preserve-3d;
      transform-origin:center;
    }

    .book-spread::before{
      content:'';
      position:absolute;
      top:0;
      bottom:0;
      left:50%;
      width:10px;
      transform:translateX(-50%);
      border-radius:12px;
      background:linear-gradient(180deg,#c478a1,#a35280);
      box-shadow:0 0 12px rgba(0,0,0,0.2);
      z-index:3;
    }

    .book-leaf{
      background:#fff5fa;
      padding:24px 28px;
      position:relative;
      overflow:hidden;
      color:#302127;
    }

    [data-theme="dark"] .book-leaf{
      background:#312733;
      color:#f6edf2;
    }

    .book-leaf::before{
      content:'';
      position:absolute;
      inset:0;
      background:
        linear-gradient(90deg,rgba(0,0,0,0.06),transparent 60%),
        radial-gradient(circle at top right, rgba(255,126,188,0.24), transparent 55%);
      border-radius:6px;
      pointer-events:none
    }

    .book-spread.turning{
      box-shadow:0 22px 46px rgba(0,0,0,0.3)
    }

    .book-spread.turning::after{
      content:'';
      position:absolute;
      top:0;
      bottom:0;
      width:52%;
      pointer-events:none;
      z-index:6;
      opacity:0;
      background:linear-gradient(90deg, rgba(40,18,34,0.35), rgba(40,18,34,0.06) 46%, rgba(255,255,255,0.2));
      filter:blur(0.5px);
    }

    .book-spread.flip-forward{
      animation:pageFlipForward 820ms cubic-bezier(0.24,0.82,0.26,1);
    }

    .book-spread.flip-forward::after{
      right:-2%;
      transform-origin:left center;
      animation:pageShadowForward 820ms ease;
    }

    .book-spread.flip-back{
      animation:pageFlipBackward 820ms cubic-bezier(0.24,0.82,0.26,1);
    }

    .book-spread.flip-back::after{
      left:-2%;
      transform-origin:right center;
      animation:pageShadowBackward 820ms ease;
    }

    .book-cover-screen,
    .book-spread{
      transition:opacity 280ms ease;
    }

    .book-cover-screen.flipping-out,
    .book-spread.flipping-out{
      opacity:0;
    }

    @keyframes pageFlipForward{
      0%{ transform:rotateY(0deg) translateX(0) scale(1); }
      38%{ transform:rotateY(-20deg) translateX(12px) scale(0.99); }
      62%{ transform:rotateY(-33deg) translateX(18px) scale(0.985); }
      100%{ transform:rotateY(0deg) translateX(0) scale(1); }
    }

    @keyframes pageFlipBackward{
      0%{ transform:rotateY(0deg) translateX(0) scale(1); }
      38%{ transform:rotateY(20deg) translateX(-12px) scale(0.99); }
      62%{ transform:rotateY(33deg) translateX(-18px) scale(0.985); }
      100%{ transform:rotateY(0deg) translateX(0) scale(1); }
    }

    @keyframes pageShadowForward{
      0%{ opacity:0; transform:scaleX(0.65) rotateY(0deg); }
      46%{ opacity:0.82; transform:scaleX(1) rotateY(-22deg); }
      100%{ opacity:0; transform:scaleX(0.7) rotateY(0deg); }
    }

    @keyframes pageShadowBackward{
      0%{ opacity:0; transform:scaleX(0.65) rotateY(0deg); }
      46%{ opacity:0.82; transform:scaleX(1) rotateY(22deg); }
      100%{ opacity:0; transform:scaleX(0.7) rotateY(0deg); }
    }

    .book-meta{
      font-size:12px;
      color:var(--muted);
      margin-bottom:12px;
      position:relative;
      z-index:2
    }

    .book-title{
      font-weight:700;
      font-size:20px;
      margin-bottom:12px;
      position:relative;
      z-index:2
    }

    .book-content{
      white-space:pre-wrap;
      line-height:1.85;
      min-height:300px;
      max-height:320px;
      overflow:auto;
      padding-right:6px;
      position:relative;
      z-index:2
    }

    .book-cover-screen{
      min-height:440px;
      border-radius:14px;
      background:linear-gradient(135deg,#f08aba,#d8689f);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:16px;
      box-shadow:inset 0 0 0 8px rgba(255,255,255,0.08)
    }

    .book-cover-screen img{
      width:min(240px,56vw);
      max-height:320px;
      object-fit:cover;
      border-radius:12px;
      box-shadow:0 20px 32px rgba(0,0,0,0.24)
    }

    .book-cover-fallback{
      width:min(240px,56vw);
      height:min(320px,74vw);
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:rgba(255,255,255,0.26);
      color:#fff;
      font-weight:700;
      text-align:center;
      padding:18px;
      box-shadow:0 20px 32px rgba(0,0,0,0.24)
    }

    .book-empty{
      color:#9a8a76;
      font-style:italic
    }

    .book-nav{
      display:flex;
      flex-direction:column;
      gap:10px
    }

    .book-nav button{
      width:56px;
      height:56px;
      border-radius:50%;
      border:none;
      background:linear-gradient(180deg,#ffd0e6,#ffb6cc);
      font-size:20px;
      cursor:pointer;
      box-shadow:0 6px 16px rgba(195,107,133,0.2)
    }

    .book-exit{
      background:#ddd
    }

    .tutorial-steps{
      margin:10px 0 14px;
      padding-left:20px;
      display:grid;
      gap:8px
    }

    .tutorial-steps li{
      line-height:1.45
    }

    .modal select{
      padding:6px 8px;
      border-radius:8px;
      border:1px solid var(--border);
      background:var(--input-bg);
      color:var(--panel-text)
    }

    footer{
      text-align:center;
      padding:20px;
      color:var(--muted);
      font-weight:700
    }

    /* RESPONSIVE FIX FULL */
    @media(max-width:600px){
      header{
        flex-direction:column;
        align-items:flex-start;
        gap:14px;
        padding:12px 16px;
      }
      .nav-right{
        width:100%;
        flex-wrap:wrap;
        gap:8px;
      }
      .nav-links a{
        padding:6px 8px;
        font-size:13px;
      }
      .btn{
        padding:8px 10px;
        font-size:13px;
        border-radius:16px;
      }
      input.search{
        min-width:100%;
        padding:8px;
      }
      .logo-img{width:36px;height:36px}
      .logo-text{font-size:18px}
      .modal{padding:14px}
      .editor{min-height:220px}
      .toolbar button,
      .toolbar select,
      .toolbar input[type="color"]{
        padding:8px;
        font-size:12px
      }
      .toolbar select{min-width:120px}
      .icon-btn{
        width:54px;
        height:54px;
        bottom:16px;
        right:16px
      }
      .notes-grid{
        grid-template-columns:1fr;
      }
      .note-card{
        min-height:120px;
      }
      #overlayEditor{
        padding:0;
        align-items:stretch;
      }
      #overlayEditor .modal{
        max-width:none;
        width:100%;
        min-height:100vh;
        border-radius:0;
        padding:12px;
      }
      .book-shell{
        flex-direction:column;
      }
      .book-nav{
        flex-direction:row;
      }
      .book-nav button{
        width:48px;
        height:48px;
      }
      .book-spread{
        grid-template-columns:1fr 1fr;
        min-width:680px;
      }
      .book-spread::before{ width:7px; }
      .book-container{
        min-height:460px;
        padding:10px;
        width:100%;
        overflow-x:auto;
      }
      .book-cover-screen{
        min-height:420px;
      }
      .book-stage{ width:100%; }
      .book-nav{ width:100%; justify-content:center; }
      .book-content{ max-height:340px; }
      .template-card img{height:140px;}
    }

    @media (min-width:601px) and (max-width:1024px){
      .book-container{
        min-height:460px;
      }
      .book-leaf{
        padding:18px 20px;
      }
      .book-content{
        max-height:280px;
      }
    }
  </style>
</head>
<body class="auth-locked">
  <header>
    <div class="logo-area">
      <img src="logodn.index.png" alt="Logo" class="logo-img" />
      <span class="logo-text">Digital Notes 2026</span>
    </div>

    <div class="nav-right">
      <nav class="nav-links">
        <a href="#" data-view="notes">Notas recientes</a>
        <a href="#" data-view="cuadernos">Mis cuadernos</a>
      </nav>

      <input class="search" placeholder="Buscar..." id="searchInput" />

      <button class="btn" id="openQuickAdd">+ Agregar Nota</button>
      <div class="export-import-group">
        <button class="btn" id="exportBtn">Exportar</button>
        <label class="btn" id="importLabel">
          Importar
          <input type="file" id="importFile" class="file-input" accept="application/json">
        </label>
      </div>
      <button class="btn calendar-btn" id="calendarBtn">üìÖ Calendario</button>
      <button class="btn" id="openSettingsBtn">‚öôÔ∏è Configuraci√≥n</button>

      <button class="btn" id="darkModeBtn">üåô</button>
    </div>
  </header>

  <main>
    <section id="view-notes">
      <h1 class="section">Notas recientes</h1>
      <div class="controls">
        <label>Filtrar por libreta:
          <select id="filterNotebook"><option value="all">Todas</option></select>
        </label>
      </div>
      <div class="notes-grid" id="notesGrid"></div>
    </section>

    <section id="view-cuadernos" class="notebook-shell" style="display:none">
      <h1 class="section">Mis cuadernos</h1>
      <p style="margin-top:-6px;color:var(--muted)">Esta vista es solo para cuadernos. Haz clic en uno para abrir su p√°gina exclusiva de notas.</p>
      <div class="notebooks" id="notebooksList">
        <div class="notebook">
          <div class="add-cover" id="addNotebookBtn">+</div>
          <p>Agregar portada</p>
        </div>
      </div>
    </section>

    <section id="view-notebook-notes" class="notebook-workspace" style="display:none">
      <div class="notebook-workspace-header">
        <div class="notebook-workspace-title-wrap">
          <button id="closeNotebookView" class="btn" style="background:#ddd">‚üµ Volver a cuadernos</button>
          <h3 id="notebookViewTitle" style="margin:0">P√°gina del cuaderno</h3>
          <p id="notebookViewSubtitle" style="margin:0;color:var(--muted)">Aqu√≠ ver√°s las notas recientes de este cuaderno.</p>
        </div>
      </div>
      <div class="notebook-mode-panel">
        <h4>Modo libreta</h4>
        <p>Vista de doble p√°gina, fondo rosa y animaciones activas en todas las hojas de este cuaderno.</p>
        <button id="openBookModeInline" class="notebook-open-mode-btn"><span class="book-icon" aria-hidden="true"></span> Abrir modo libreta</button>
      </div>
      <div class="notebook-notes" id="notebookNotesGrid"></div>
    </section>
  </main>

  <!-- Overlay para cuadernos -->
  <div class="overlay" id="overlayNotebook">
    <div class="modal">
      <h3 id="nbModalTitle">Nuevo cuaderno</h3>
      <input id="nbName" placeholder="Nombre del cuaderno" class="title-input" />
      <label>Portada: <input type="file" id="nbCoverFile" accept="image/*"></label>
      <label>Color del cuaderno: <input type="color" id="nbCoverColor" value="#f08aba"></label>
      <div style="display:flex;gap:10px;margin-top:12px;justify-content:flex-end">
        <button id="nbCancel" class="btn" style="background:#ddd">Cancelar</button>
        <button id="nbSave" class="btn">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Overlay para editor de notas -->
  <div class="overlay" id="overlayEditor">
    <div class="modal editor-modal" id="editorModal">
      <input id="noteTitle" class="title-input" placeholder="T√≠tulo (opcional)" />
      <div style="display:flex;gap:10px;align-items:center;margin-bottom:8px;flex-wrap:wrap">
        <div class="toolbar">
          <div class="tool-group">
            <button data-cmd="bold">B</button>
            <button data-cmd="italic">I</button>
            <button data-cmd="underline">U</button>
            <button data-cmd="insertUnorderedList">‚Ä¢ Lista</button>
            <button data-cmd="insertOrderedList">1. Lista</button>
            <button id="insertChecklist">‚òëÔ∏è</button>
          </div>
          <div class="tool-group">
            <span class="tool-label">Alinear</span>
            <button data-align="left">‚¨ÖÔ∏è</button>
            <button data-align="center">‚ÜîÔ∏è</button>
            <button data-align="right">‚û°Ô∏è</button>
          </div>
          <div class="tool-group">
            <button id="textColorTool" class="text-color-tool" title="Color de texto">A</button>
            <input type="color" id="textColorToolPicker" class="text-color-picker" value="#6b4350" title="Paleta de color de texto">
          </div>
          <div class="tool-group">
            <button id="fontDecrease" title="Disminuir tama√±o">A-</button>
            <button id="fontIncrease" title="Aumentar tama√±o">A+</button>
            <select id="fontSelect">
              <option value="">Fuente</option>
              <option value="Arial">Arial</option>
              <option value="Montserrat">Montserrat</option>
              <option value="Georgia">Georgia</option>
              <option value="Times New Roman">Times New Roman</option>
              <option value="Verdana">Verdana</option>
              <option value="Courier New">Courier New</option>
              <option value="Comic Sans MS">Comic Sans MS</option>
            </select>
            <select id="emojiSelect">
              <option value="">üòä Emoji</option>
              <option>üòÄ</option>
              <option>üòç</option>
              <option>‚ú®</option>
              <option>üî•</option>
              <option>üå∏</option>
              <option>üìå</option>
              <option>‚úÖ</option>
              <option>üß†</option>
              <option>üìö</option>
              <option>üí°</option>
              <option>üéØ</option>
            </select>
          </div>
          <div class="tool-group">
            <input type="color" id="highlightColor" value="#fff2a8" title="Subrayado de color">
            <button id="applyHighlight">üñçÔ∏è</button>
            <button id="toggleCompactPalette" title="Color de fondo">üé® Fondo</button>
            <button id="openColorPanel">M√°s colores</button>
          </div>
          <div class="tool-group">
            <button id="insertImageBtn">üñºÔ∏è</button>
            <button id="openFullscreenDraw">‚úèÔ∏è Dibujo completo</button>
            <button id="insertTemplateBtn">üìÑ Plantilla</button>
            <input type="file" id="noteImageFile" accept="image/*" class="file-input">
          </div>
        </div>
        <label>Guardar en:
          <select id="editorNotebook"></select>
        </label>
        <div style="margin-left:auto;display:flex;gap:8px">
          <button id="deleteNoteBtn" style="background:#f88;border-radius:8px;padding:8px;border:none;color:#fff;display:none">Eliminar</button>
          <button id="fullscreenEditorBtn" class="btn" style="background:#e7d5dc">‚õ∂ Pantalla completa</button>
          <button id="closeEditor" class="btn" style="background:#ddd">Cerrar</button>
          <button id="saveNote" class="btn">Guardar</button>
        </div>
      </div>

      <div class="compact-color-palette" id="compactColorPalette">
        <div class="compact-color-grid" id="compactColorGrid"></div>
      </div>

      <div id="colorPanel" style="display:none;margin-bottom:10px">
        <div class="color-panel">
          <div class="row">
            <div class="color-preview" id="colorPreview"></div>
          </div>
          <div class="color-controls">
            <div class="row"><label>Hue</label><input type="range" id="hRange" min="0" max="360" value="330"></div>
            <div class="row"><label>Saturation</label><input type="range" id="sRange" min="0" max="100" value="80"></div>
            <div class="row"><label>Light</label><input type="range" id="lRange" min="0" max="100" value="90"></div>
            <div class="row"><label>Alpha</label><input type="range" id="aRange" min="0" max="1" step="0.01" value="1"></div>
            <div class="row"><button id="applyBgColor" class="btn">Aplicar fondo</button></div>
            <div style="margin-top:6px"><strong>Paleta r√°pida:</strong></div>
            <div class="palette" id="quickPalette"></div>
          </div>
        </div>
      </div>

      <div class="drawing-board" id="drawingBoard">
        <div class="draw-toolbar">
          <label>Color <input type="color" id="drawColor" value="#d4629b"></label>
          <label>Tama√±o <input type="range" id="drawSize" min="1" max="25" value="4"></label>
          <label>Pincel
            <select id="drawBrush">
              <option value="round">Redondo</option>
              <option value="square">Cuadrado</option>
              <option value="marker">Marcador</option>
            </select>
          </label>
          <button id="drawEraser">Borrador</button>
          <button id="clearDrawCanvas">Limpiar</button>
          <button id="saveDrawingBtn" class="btn">Guardar dibujo</button>
        </div>
        <canvas id="drawCanvas" width="860" height="220"></canvas>
      </div>

      <div id="templatePanel" class="drawing-board">
        <div class="draw-toolbar">
          <span class="tool-label">Plantillas r√°pidas</span>
          <button class="template-btn" data-template="plantilla1.png">Plantilla 1</button>
          <button class="template-btn" data-template="plantilla2.png">Plantilla 2</button>
          <button class="template-btn" data-template="plantilla3.png">Plantilla 3</button>
          <button class="template-btn" data-template="plantilla4.png">Plantilla 4</button>
          <button class="template-btn" data-template="plantilla5.png">Plantilla 5</button>
        </div>
      </div>

      <div class="template-gallery" id="templateGalleryEditor">
        <h3>Galer√≠a de plantillas</h3>
        <p style="margin:0 0 12px;color:var(--muted)">Esta sesi√≥n es para agregar notas con plantilla. Elige una para escribir o dibujar en pantalla completa.</p>
        <div class="template-grid" id="templateGridEditor"></div>
      </div>

      <div class="image-controls" id="imageControls">
        <label>Tama√±o
          <input type="range" id="imageSize" min="20" max="100" value="70">
        </label>
        <label>Rotar
          <input type="range" id="imageRotate" min="-180" max="180" value="0">
        </label>
        <label>Posici√≥n
          <select id="imageAlign">
            <option value="left">Izquierda</option>
            <option value="center">Centro</option>
            <option value="right">Derecha</option>
          </select>
        </label>
        <button id="pinImageBtn">Fijar imagen</button>
        <button id="removeImageBtn">Eliminar imagen</button>
      </div>

      <div class="editor-shell">
        <div id="editor" class="editor" contenteditable="true" spellcheck="true"></div>
        <div class="editor-scroll" aria-label="Navegaci√≥n r√°pida">
          <button id="scrollUpBtn" title="Subir">‚¨ÜÔ∏è</button>
          <button id="scrollDownBtn" title="Bajar">‚¨áÔ∏è</button>
        </div>
      </div>
    </div>
  </div>


  <div class="overlay" id="overlayCalendar">
    <div class="modal calendar-modal">
      <div class="calendar-head">
        <button id="calendarPrev" class="btn" style="padding:8px 10px">‚óÄ</button>
        <h3 id="calendarTitle" style="margin:0">Calendario</h3>
        <button id="calendarNext" class="btn" style="padding:8px 10px">‚ñ∂</button>
      </div>
      <div class="calendar-grid" id="calendarGrid"></div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button id="closeCalendar" class="btn" style="background:#ddd">Cerrar</button>
        <button id="insertCalendarDate" class="btn">Insertar fecha</button>
      </div>
    </div>
  </div>

  <!-- Overlay para modo libreta -->
  <div class="overlay" id="overlayBookMode">
    <div class="modal" style="max-width:1080px">
      <div class="book-topbar">
        <button id="backToNotebookView" class="btn" style="background:#ddd">‚üµ Volver</button>
        <h3 id="bookModeTitle" style="margin:0">Modo Libreta</h3>
        <button id="exitBookMode" class="btn book-exit">Cerrar</button>
      </div>
      <div class="book-shell">
        <div class="book-nav">
          <button id="prevPageBtn" title="P√°gina anterior">‚¨ÖÔ∏è</button>
        </div>
        <div class="book-stage">
          <div class="book-container" id="bookContainer">
            <div class="book-cover-screen" id="bookCoverScreen">
              <img id="bookCoverImage" src="" alt="Portada del cuaderno" style="display:none">
              <div id="bookCoverFallback" class="book-cover-fallback"></div>
              <button id="openNotebookPages" class="btn">Abrir cuaderno</button>
            </div>
            <div class="book-spread" id="bookSpread" style="display:none">
              <div class="book-leaf" id="bookLeftPage">
                <div class="book-meta" id="bookLeftMeta"></div>
                <div class="book-title" id="bookLeftTitle"></div>
                <div class="book-content" id="bookLeftContent"></div>
              </div>
              <div class="book-leaf" id="bookRightPage">
                <div class="book-meta" id="bookRightMeta"></div>
                <div class="book-title" id="bookRightTitle"></div>
                <div class="book-content" id="bookRightContent"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="book-nav">
          <button id="nextPageBtn" title="P√°gina siguiente">‚û°Ô∏è</button>
        </div>
      </div>
    </div>
  </div>

  <div class="overlay" id="overlayTutorial">
    <div class="modal" style="max-width:760px">
      <h3>üëã Bienvenido/a a Digital Notes</h3>
      <p>Mini tutorial r√°pido de herramientas:</p>
      <ol class="tutorial-steps">
        <li><strong>+ Agregar Nota</strong>: crea una nota nueva al instante.</li>
        <li><strong>Barra de formato</strong>: negrita, cursiva, listas, alineaci√≥n y resaltado.</li>
        <li><strong>üé® Fondo</strong>: cambia el color de la nota y se ver√° igual en recientes y cuadernos.</li>
        <li><strong>üñºÔ∏è Imagen</strong>: inserta fotos en la nota para ver miniatura en notas recientes.</li>
        <li><strong>Mis cuadernos</strong>: organiza tus notas por categor√≠a y √°brelas en Modo Libreta.</li>
        <li><strong>Exportar/Importar</strong>: respalda y restaura todo tu contenido.</li>
      </ol>
      <div style="display:flex;justify-content:flex-end;gap:8px">
        <button id="tutorialClose" class="btn">Entendido</button>
      </div>
    </div>
  </div>

  <div class="draw-fullscreen-overlay" id="drawFullscreenOverlay">
    <div class="draw-fullscreen-toolbar">
      <button id="closeFullscreenDraw">Cerrar</button>
      <label>Color <input type="color" id="drawFsColor" value="#d4629b"></label>
      <label>Tama√±o <input type="range" id="drawFsSize" min="1" max="32" value="5"></label>
      <label>Pincel
        <select id="drawFsBrush">
          <option value="round">Redondo</option>
          <option value="square">Cuadrado</option>
          <option value="marker">Marcador</option>
        </select>
      </label>
      <button id="drawFsEraser">Borrador</button>
      <button id="drawFsClear">Limpiar</button>
      <button id="drawFsSave" class="btn">Guardar en nota</button>
    </div>
    <canvas id="drawFullscreenCanvas" width="1600" height="900"></canvas>
  </div>

  <div class="overlay" id="overlayTemplateEditor">
    <div class="modal" style="max-width:1200px;padding:0;overflow:hidden">
      <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:var(--panel-bg);border-bottom:1px solid var(--border)">
        <strong id="templateEditorTitle">Editor de plantilla</strong>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <label>Color <input type="color" id="templateDrawColor" value="#2e2e2e"></label>
          <label>Tama√±o <input type="range" id="templateDrawSize" min="1" max="28" value="3"></label>
          <label>Pincel
            <select id="templateDrawBrush">
              <option value="round">Redondo</option>
              <option value="square">Cuadrado</option>
              <option value="marker">Marcador</option>
            </select>
          </label>
          <button id="templateEraserBtn">Borrador</button>
          <button id="templateClearBtn">Limpiar</button>
          <button id="templateSaveBtn" class="btn">Guardar en nota</button>
          <button id="templateCloseBtn" class="btn" style="background:#ddd">Cerrar</button>
        </div>
      </div>
      <div style="position:relative;height:min(88vh,1000px);background:#111">
        <img id="templateBgImage" alt="Plantilla seleccionada" style="position:absolute;inset:0;width:100%;height:100%;object-fit:contain;pointer-events:none;user-select:none;-webkit-user-drag:none;">
        <canvas id="templateDrawCanvas" width="1400" height="920" style="position:absolute;inset:0;width:100%;height:100%;touch-action:none"></canvas>
      </div>
    </div>
  </div>

  <div class="overlay" id="overlayTemplatePreview">
    <div class="modal" style="max-width:860px">
      <h3 style="margin-top:0">Vista de plantilla</h3>
      <img id="templatePreviewImage" alt="Plantilla ampliada" style="width:100%;max-height:65vh;object-fit:contain;border-radius:12px;border:1px solid var(--border)">
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button id="templatePreviewClose" class="btn" style="background:#ddd">Cerrar</button>
        <button id="templatePreviewEdit" class="btn">Editar en pantalla completa</button>
      </div>
    </div>
  </div>

  <div class="overlay" id="overlaySettings">
    <div class="modal" style="max-width:460px">
      <h3 style="margin-top:0">Configuraci√≥n de cuenta</h3>
      <p id="settingsUserName" style="margin:0 0 6px"></p>
      <p id="settingsUserEmail" style="margin:0 0 6px"></p>
      <p id="settingsUserBirth" style="margin:0 0 16px"></p>
      <div style="display:flex;justify-content:flex-end;gap:8px">
        <button id="closeSettingsBtn" class="btn" style="background:#ddd">Cerrar</button>
        <button id="logoutBtn" class="btn">Cerrar sesi√≥n</button>
      </div>
    </div>
  </div>

  <div class="auth-overlay" id="authOverlay">
    <div class="auth-card">
      <h1 id="authTitle">Crea una cuenta</h1>
      <p><span id="authPrompt">¬øYa est√°s registrado/a?</span> <button id="toggleAuthMode" type="button">Inicia sesi√≥n</button></p>
      <label>NOMBRE
        <input id="authName" type="text" placeholder="Tu nombre">
      </label>
      <label>EMAIL
        <input id="authEmail" type="email" placeholder="tu@email.com">
      </label>
      <label>CONTRASE√ëA
        <input id="authPassword" type="password" placeholder="******">
      </label>
      <label>FECHA DE NACIMIENTO
        <input id="authBirth" type="date">
      </label>
      <button id="authSubmit" type="button">Registrarse</button>
      <p id="authMessage" style="min-height:24px;margin:12px 0 0;color:#fff;font-weight:700"></p>
    </div>
  </div>

  <div id="appToast" class="toast-msg" aria-live="polite"></div>

  <div class="icon-btn" id="fab" title="Agregar nota">
    <img src="logodn.index.png" alt="Digital Notes" style="width:36px;height:36px;object-fit:contain;border-radius:8px">
  </div>

  <footer>
    ¬© 2026 Digital Notes. Todos los derechos reservados.
  </footer>

  <template id="noteCardTemplate">
    <div class="note-card" draggable="true">
      <div class="note-title"></div>
      <div class="note-body"></div>
      <div class="note-meta"></div>
    </div>
  </template>

  <script>
    /* ---------------------------
       Digital Notes 2026 - JS
       Todo en un solo archivo
       --------------------------- */
    const STORAGE_KEY = 'digitalNotesData_v7';
    const ONBOARDING_KEY = 'digitalNotesOnboarding_v1';
    const CALENDAR_STABLE_KEY = 'digitalNotesCalendarStable_v1';
    const AUTH_USERS_KEY = 'digitalNotesUsers_v1';
    const AUTH_SESSION_KEY = 'digitalNotesSession_v1';
    let state = { notebooks: [], notes: [], darkMode: false };
    const uid = ()=>Date.now().toString(36)+Math.random().toString(36).slice(2,7);
    const qs = s => document.querySelector(s);
    const qsa = s => document.querySelectorAll(s);

    // --- Helpers ---
    const truncate = (str,len)=>{ if(!str) return ''; return str.length>len? str.slice(0,len)+'...':str; };
    const stripHtml = html=>{ const div=document.createElement('div'); div.innerHTML=html; return div.textContent||div.innerText||''; };
    const getFirstImageSrc = html=>{
      if(!html) return null;
      const div = document.createElement('div');
      div.innerHTML = html;
      return div.querySelector('img')?.src || null;
    };
    const fileToDataUrl = file=> new Promise(res=>{ const r=new FileReader(); r.onload=e=>res(e.target.result); r.readAsDataURL(file); });
    const getLocaleTag = ()=> navigator.language || Intl.DateTimeFormat().resolvedOptions().locale || 'es-MX';
    const TEMPLATE_ITEMS = [
      { src:'plantilla1.png', name:'Plantilla 1' },
      { src:'plantilla2.png', name:'Plantilla 2' },
      { src:'plantilla3.png', name:'Plantilla 3' },
      { src:'plantilla4.png', name:'Plantilla 4' },
      { src:'plantilla5.png', name:'Plantilla 5' }
    ];


    let authMode = 'register';
    let currentUser = null;
    let lastManualSavedSnapshot = '';
    let saveStatusTimer = null;

    function readUsers(){
      try { return JSON.parse(localStorage.getItem(AUTH_USERS_KEY) || '[]'); } catch(_e){ return []; }
    }
    function writeUsers(users){ localStorage.setItem(AUTH_USERS_KEY, JSON.stringify(users)); }
    function getSession(){
      try { return JSON.parse(localStorage.getItem(AUTH_SESSION_KEY) || 'null'); } catch(_e){ return null; }
    }
    function setSession(user){
      currentUser = user;
      localStorage.setItem(AUTH_SESSION_KEY, JSON.stringify(user));
      document.body.classList.remove('auth-locked');
      qs('#authOverlay').style.display = 'none';
      qs('.logo-text').textContent = `Digital Notes 2026 ¬∑ ${user.name}`;
      updateSettingsPanel();
    }

    function getFirstName(name=''){
      return name.trim().split(/\s+/)[0] || 'usuario';
    }

    function showToast(message){
      const toast = qs('#appToast');
      toast.textContent = message;
      toast.classList.add('show');
      clearTimeout(showToast.timer);
      showToast.timer = setTimeout(()=>toast.classList.remove('show'), 2400);
    }

    function showWelcomeMessage(user, isNewUser=false){
      const firstName = getFirstName(user.name);
      if(isNewUser){
        showToast('Se ha registrado con √©xito');
        setTimeout(()=>showToast(`Hola, bienvenido ${firstName}`), 300);
        return;
      }
      showToast(`Hola de vuelta ${firstName}`);
    }
    function clearSession(){
      currentUser = null;
      localStorage.removeItem(AUTH_SESSION_KEY);
      document.body.classList.add('auth-locked');
      qs('#authOverlay').style.display = 'flex';
    }

    function updateAuthMode(){
      const register = authMode === 'register';
      qs('#authTitle').textContent = register ? 'Crea una cuenta' : 'Inicia sesi√≥n';
      qs('#authPrompt').textContent = register ? '¬øYa est√°s registrado/a?' : '¬øA√∫n no tienes cuenta?';
      qs('#toggleAuthMode').textContent = register ? 'Inicia sesi√≥n' : 'Reg√≠strate';
      qs('#authSubmit').textContent = register ? 'Registrarse' : 'Entrar';
      qs('#authName').parentElement.style.display = register ? 'block' : 'none';
      qs('#authBirth').parentElement.style.display = register ? 'block' : 'none';
      qs('#authMessage').textContent = '';
    }

    function submitAuth(){
      const users = readUsers();
      const name = qs('#authName').value.trim();
      const email = qs('#authEmail').value.trim().toLowerCase();
      const password = qs('#authPassword').value;
      const birth = qs('#authBirth').value;
      const msg = qs('#authMessage');
      if(!email || !password){ msg.textContent = 'Email y contrase√±a son obligatorios.'; return; }
      if(authMode === 'register'){
        if(!name || !birth){ msg.textContent = 'Completa nombre y fecha de nacimiento.'; return; }
        if(users.some(u=>u.email===email)){ msg.textContent = 'Ese email ya est√° registrado.'; return; }
        const user = {id:uid(), name, email, password, birth};
        users.push(user);
        writeUsers(users);
        setSession({id:user.id,name:user.name,email:user.email,birth:user.birth});
        showWelcomeMessage(user, true);
      } else {
        const user = users.find(u=>u.email===email && u.password===password);
        if(!user){ msg.textContent = 'Credenciales inv√°lidas.'; return; }
        setSession({id:user.id,name:user.name,email:user.email,birth:user.birth});
        showWelcomeMessage(user, false);
      }
      msg.textContent = '';
    }

    function bootstrapAuth(){
      updateAuthMode();
      qs('#toggleAuthMode').addEventListener('click', ()=>{ authMode = authMode === 'register' ? 'login' : 'register'; updateAuthMode(); });
      qs('#authSubmit').addEventListener('click', submitAuth);
      const session = getSession();
      if(session){ setSession(session); showWelcomeMessage(session, false); }
    }

    function updateSettingsPanel(){
      if(!currentUser) return;
      qs('#settingsUserName').textContent = `Nombre: ${currentUser.name}`;
      qs('#settingsUserEmail').textContent = `Email: ${currentUser.email}`;
      qs('#settingsUserBirth').textContent = `Nacimiento: ${currentUser.birth || 'No definido'}`;
    }

    // --- Storage ---
    function loadState(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw){ try { state = JSON.parse(raw); } catch(e){ state = {notebooks:[],notes:[], darkMode:false}; } }
      if(!state.notebooks || state.notebooks.length===0){ state.notebooks = [{id:uid(),name:'General',cover:null}]; saveState(); }
      if(!state.notes) state.notes = [];
      state.notes = state.notes.map(note=>({created: note.created || note.updated || Date.now(), ...note}));
      if(state.darkMode) document.body.setAttribute('data-theme','dark');
    }
    function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

    // --- Dark mode ---
    function toggleDarkMode(){
      state.darkMode = !state.darkMode;
      if(state.darkMode) document.body.setAttribute('data-theme','dark');
      else document.body.removeAttribute('data-theme');
      saveState();
    }
    qs('#darkModeBtn').onclick = toggleDarkMode;

    // --- Render Notebooks ---
    function renderNotebooks(){
      const container = qs('#notebooksList'); container.innerHTML='';
      const addDiv = document.createElement('div'); addDiv.className='notebook'; addDiv.innerHTML = `<div class='add-cover' id='addNotebookBtn'>+</div><p>Agregar portada</p>`; container.appendChild(addDiv);

      state.notebooks.forEach(nb=>{
        const el = document.createElement('div'); el.className='notebook';
        el.dataset.id = nb.id;
        const img = document.createElement('img');
        img.src = nb.cover || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="300" height="400"><rect width="100%" height="100%" fill="%23f0f0f0"/></svg>';
        const dots = document.createElement('div'); dots.className='dots'; dots.textContent='‚ãÆ';
        const menu = document.createElement('div'); menu.className='menu';
        const editBtn = document.createElement('button'); editBtn.textContent='Editar portada';
        const renameBtn = document.createElement('button'); renameBtn.textContent='Renombrar';
        const delBtn = document.createElement('button'); delBtn.textContent='Eliminar';
        menu.appendChild(editBtn); menu.appendChild(renameBtn); menu.appendChild(delBtn);
        el.appendChild(img); el.appendChild(dots); el.appendChild(menu);
        const p = document.createElement('p'); p.textContent = nb.name; el.appendChild(p);

        // dragover/drop for notes
        el.addEventListener('dragover', (e)=>{ e.preventDefault(); el.classList.add('drop-target'); });
        el.addEventListener('dragleave', ()=> el.classList.remove('drop-target'));
        el.addEventListener('drop', (e)=>{
          e.preventDefault(); el.classList.remove('drop-target');
          const noteId = e.dataTransfer.getData('text/note-id');
          if(noteId){ moveNoteToNotebook(noteId, nb.id); }
        });

        dots.addEventListener('click', e=>{ e.stopPropagation(); closeAllMenus(); menu.style.display = menu.style.display==='block' ? 'none' : 'block'; });
        editBtn.addEventListener('click', e=>{ e.stopPropagation(); openNotebookModal(nb); menu.style.display='none'; });
        renameBtn.addEventListener('click', e=>{ e.stopPropagation(); openNotebookModal(nb, {renameOnly:true}); menu.style.display='none'; });
        delBtn.addEventListener('click', e=>{ e.stopPropagation(); if(confirm('¬øEliminar cuaderno y sus notas?')) deleteNotebook(nb.id); menu.style.display='none'; });
        img.addEventListener('click', ()=>{ setActiveNotebookCard(nb.id); openNotebookView(nb.id); });
        p.addEventListener('click', ()=>{ setActiveNotebookCard(nb.id); openNotebookView(nb.id); });

        container.appendChild(el);
      });
      qs('#addNotebookBtn')?.addEventListener('click', ()=> openNotebookModal());
      setActiveNotebookCard(activeNotebookId);
      populateNotebookFilters();
    }
    function closeAllMenus(){ qsa('.menu').forEach(m=>m.style.display='none'); }

    function setActiveNotebookCard(notebookId){
      qsa('#notebooksList .notebook[data-id]').forEach(card=>{
        card.classList.toggle('active-lift', card.dataset.id === notebookId);
      });
    }

    // --- Render Notes ---
    function renderNotes(){
      const grid = qs('#notesGrid'); grid.innerHTML='';
      const filterId = qs('#filterNotebook').value;
      const searchVal = qs('#searchInput').value.toLowerCase();
      const notesToRender = state.notes.filter(n=>{
        const matchNotebook = filterId==='all'||n.notebook===filterId;
        const matchSearch = !searchVal || (stripHtml(n.content).toLowerCase().includes(searchVal) || (n.title||'').toLowerCase().includes(searchVal));
        return matchNotebook && matchSearch;
      }).sort((a,b)=>b.updated - a.updated);

      notesToRender.forEach(n=>{
        const card = document.createElement('div'); card.className='note-card'; card.draggable=true;
        card.dataset.id=n.id;
        const title = document.createElement('div'); title.className='note-title'; title.textContent=truncate(n.title,35);
        const body = document.createElement('div'); body.className='note-body preview'; body.textContent = truncate(stripHtml(n.content), 160);
        const firstImage = getFirstImageSrc(n.content);
        const meta = document.createElement('div'); meta.className='note-meta'; meta.textContent = new Date(n.updated).toLocaleString(getLocaleTag());
        card.appendChild(title);
        card.appendChild(body);
        if(firstImage){ const thumb = document.createElement('img'); thumb.className='note-thumb small'; thumb.src=firstImage; thumb.alt='Imagen de la nota'; card.appendChild(thumb); }
        card.appendChild(meta);
        if(n.bgColor) card.style.background=n.bgColor;
        if(n.textColor) card.style.color=n.textColor;
        card.addEventListener('click', ()=>openEditor(n));
        card.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/note-id', n.id); });
        grid.appendChild(card);
      });
    }

    function renderTemplateGallery(){
      const grid = qs('#templateGridEditor');
      if(!grid) return;
      grid.innerHTML = '';
      TEMPLATE_ITEMS.forEach(template=>{
        const card = document.createElement('button');
        card.type = 'button';
        card.className = 'template-card';
        card.innerHTML = `<img src="${template.src}" alt="${template.name}"><span>${template.name}</span>`;
        card.addEventListener('click', ()=>openTemplateEditor(template));
        grid.appendChild(card);
      });
    }

    function getNotebookNotes(notebookId){
      return state.notes.filter(n=>n.notebook===notebookId).sort((a,b)=>a.created - b.created);
    }

    let activeNotebookId = null;
    let bookPageIndex = 0;
    let isBookOpen = false;

    function openNotebookView(notebookId){
      activeNotebookId = notebookId;
      setActiveNotebookCard(notebookId);
      const nb = state.notebooks.find(n=>n.id===notebookId);
      qs('#notebookViewTitle').textContent = nb ? `Notas de: ${nb.name}` : 'P√°gina del cuaderno';
      qs('#notebookViewSubtitle').textContent = nb ? `Secci√≥n exclusiva para las notas guardadas en ${nb.name}.` : 'Aqu√≠ ver√°s las notas recientes de este cuaderno.';
      const grid = qs('#notebookNotesGrid');
      qs('#view-cuadernos').style.display = 'none';
      qs('#view-notebook-notes').style.display = 'block';
      grid.innerHTML = '';
      const notes = getNotebookNotes(notebookId);
      if(notes.length === 0){
        const empty = document.createElement('div');
        empty.textContent = 'Este cuaderno a√∫n no tiene notas.';
        grid.appendChild(empty);
      } else {
        notes.forEach(n=>{
          const card = document.createElement('div');
          card.className = 'note-card';
          const title = document.createElement('div'); title.className='note-title'; title.textContent=truncate(n.title || 'Sin t√≠tulo', 60);
          const body = document.createElement('div'); body.className='note-body preview'; body.textContent = truncate(stripHtml(n.content), 250);
          const firstImage = getFirstImageSrc(n.content);
          const meta = document.createElement('div'); meta.className='note-meta'; meta.textContent = new Date(n.updated).toLocaleString(getLocaleTag());
          if(n.bgColor) card.style.background = n.bgColor;
          if(n.textColor) card.style.color = n.textColor;
          card.appendChild(title);
          card.appendChild(body);
          if(firstImage){ const thumb=document.createElement('img'); thumb.className='note-thumb small'; thumb.src=firstImage; thumb.alt='Imagen de la nota'; card.appendChild(thumb); }
          card.appendChild(meta);
          card.addEventListener('click', ()=>openEditor(n));
          grid.appendChild(card);
        });
      }
    }

    function closeNotebookView(){
      qs('#view-notebook-notes').style.display='none';
      qs('#view-cuadernos').style.display='block';
      activeNotebookId = null;
      setActiveNotebookCard(null);
    }


    function refreshNotebookWorkspace(){
      if(activeNotebookId && qs('#view-notebook-notes').style.display === 'block'){
        openNotebookView(activeNotebookId);
      }
    }

    function setBookCover(notebook){
      const coverImg = qs('#bookCoverImage');
      const coverFallback = qs('#bookCoverFallback');
      coverImg.style.display = 'none';
      if(notebook?.cover){
        coverImg.src = notebook.cover;
        coverImg.alt = `Portada de ${notebook.name}`;
        coverImg.style.display = 'block';
        coverFallback.style.display = 'none';
      } else {
        coverFallback.style.display = 'flex';
        coverFallback.textContent = notebook?.name || 'Sin portada';
      }
      qs('#bookContainer').style.background = notebook?.coverColor || 'linear-gradient(150deg,#ffcae3,#f7b7d8)';
    }

    function showBookCover(){
      isBookOpen = false;
      qs('#bookCoverScreen').style.display = 'flex';
      qs('#bookSpread').style.display = 'none';
    }

    function animateBookSurfaceTransition(fromEl, toEl){
      if(!fromEl || !toEl) return;
      fromEl.classList.add('flipping-out');
      setTimeout(()=>{
        fromEl.style.display = 'none';
        fromEl.classList.remove('flipping-out');
        toEl.style.display = toEl.id === 'bookSpread' ? 'grid' : 'flex';
        toEl.classList.add('flipping-out');
        requestAnimationFrame(()=>toEl.classList.remove('flipping-out'));
      }, 240);
    }

    function openNotebookPages(){
      isBookOpen = true;
      animateBookSurfaceTransition(qs('#bookCoverScreen'), qs('#bookSpread'));
      updateBookPage('forward');
    }

    function openBookMode(){
      if(!activeNotebookId) return;
      bookPageIndex = 0;
      const nb = state.notebooks.find(n=>n.id===activeNotebookId);
      qs('#bookModeTitle').textContent = nb ? `Modo Libreta: ${nb.name}` : 'Modo Libreta';
      setBookCover(nb);
      showBookCover();
      qs('#overlayBookMode').style.display='flex';
    }

    function closeBookMode(){
      qs('#overlayBookMode').style.display='none';
      showBookCover();
    }

    function fillBookLeaf(side, note, displayIndex, total){
      const title = qs(`#book${side}Title`);
      const content = qs(`#book${side}Content`);
      const meta = qs(`#book${side}Meta`);
      const page = qs(`#book${side}Page`);
      if(!note){
        title.textContent = 'Hoja disponible';
        content.innerHTML = '<p class="book-empty">Esta hoja est√° libre para tu pr√≥xima nota.</p>';
        meta.textContent = '';
        page.style.background = '#f6ecd2';
        page.style.color = '';
        return;
      }
      title.textContent = note.title || 'Sin t√≠tulo';
      content.innerHTML = note.content || '<p class="book-empty">Sin contenido.</p>';
      meta.textContent = `Hoja ${displayIndex} de ${total} ¬∑ ${new Date(note.updated).toLocaleDateString(getLocaleTag())}`;
      page.style.background = note.bgColor || '#f6ecd2';
      page.style.color = note.textColor || '';
    }

    function updateBookPage(direction='forward'){
      const notes = getNotebookNotes(activeNotebookId);
      const spread = qs('#bookSpread');
      const nb = state.notebooks.find(n=>n.id===activeNotebookId);
      qs('#bookModeTitle').textContent = nb ? `Modo Libreta: ${nb.name}` : 'Modo Libreta';
      if(notes.length === 0){
        fillBookLeaf('Left', null, 0, 0);
        fillBookLeaf('Right', null, 0, 0);
        qs('#bookLeftTitle').textContent = 'Sin notas';
        qs('#bookLeftContent').innerHTML = '<p class="book-empty">Agrega una nota para empezar tu libreta.</p>';
        qs('#bookRightTitle').textContent = 'Libreta lista';
        qs('#bookRightContent').innerHTML = '<p class="book-empty">Cada nota ocupar√° solo una hoja.</p>';
        return;
      }
      const leftIndex = bookPageIndex;
      const rightIndex = bookPageIndex + 1;
      fillBookLeaf('Left', notes[leftIndex], leftIndex + 1, notes.length);
      fillBookLeaf('Right', notes[rightIndex], rightIndex + 1, notes.length);
      spread.classList.remove('flip-forward','flip-back','turning');
      requestAnimationFrame(()=>{
        spread.classList.add('turning', direction === 'back' ? 'flip-back' : 'flip-forward');
        setTimeout(()=>spread.classList.remove('flip-forward','flip-back','turning'), 840);
      });
    }

    // --- Events and UI wiring ---
    qs('#filterNotebook').addEventListener('change', renderNotes);
    qs('#searchInput').addEventListener('input', renderNotes);
    qs('#closeEditor').addEventListener('click', ()=>closeEditor());
    document.addEventListener('keydown', e=>{ if(e.key==='Escape'){ closeEditor(); qs('#overlayNotebook').style.display='none'; closeNotebookView(); closeBookMode(); closeCalendarModal(); } });
    qs('#closeNotebookView').addEventListener('click', closeNotebookView);
    qs('#openBookModeInline').addEventListener('click', openBookMode);
    qs('#exitBookMode').addEventListener('click', closeBookMode);
    qs('#backToNotebookView').addEventListener('click', closeBookMode);
    qs('#openNotebookPages').addEventListener('click', openNotebookPages);
    qs('#tutorialClose').addEventListener('click', ()=>{ qs('#overlayTutorial').style.display='none'; localStorage.setItem(ONBOARDING_KEY, 'done'); });
    qs('#prevPageBtn').addEventListener('click', ()=>{
      const notes = getNotebookNotes(activeNotebookId);
      if(notes.length === 0 || !isBookOpen) return;
      bookPageIndex = Math.max(0, bookPageIndex - 2);
      updateBookPage('back');
    });
    qs('#nextPageBtn').addEventListener('click', ()=>{
      const notes = getNotebookNotes(activeNotebookId);
      if(notes.length === 0 || !isBookOpen) return;
      bookPageIndex = Math.min(Math.max(0, notes.length - 1), bookPageIndex + 2);
      if(bookPageIndex % 2 !== 0) bookPageIndex -= 1;
      updateBookPage('forward');
    });

    // --- Notes CRUD ---
    let editingNote=null;
    let currentImage = null;
    function openEditor(note=null){
      editingNote = note;
      qs('#overlayEditor').style.display='flex';
      qs('#noteTitle').value = note?.title||'';
      qs('#editor').innerHTML = note?.content||'';
      qs('#deleteNoteBtn').style.display = note ? 'inline-block':'none';
      populateEditorNotebook();
      setupAutosave();
      qs('#imageControls').style.display = 'none';
      currentImage = null;
      const noteTitle = note?.title || '';
      const noteContent = note?.content || '';
      const noteNotebook = note?.notebook || (state.notebooks[0]?.id || '');
      lastManualSavedSnapshot = `${noteTitle}::${noteContent}::${noteNotebook}`;
      qs('#saveNote').textContent = 'Guardar';
      qs('#saveNote').classList.remove('saving','saved');
      qs('#editorModal').classList.remove('fullscreen');
      qs('#fullscreenEditorBtn').textContent = '‚õ∂ Pantalla completa';
      // set current colors preview
      if(note){
        if(note.bgColor) qs('#colorPreview').style.background = note.bgColor;
        qs('#editor').style.background = note.bgColor || '';
        qs('#editor').style.color = note.textColor || '';
        if(note.textColor) qs('#textColorToolPicker').value = note.textColor;
      } else {
        qs('#colorPreview').style.background = '';
        qs('#editor').style.background = '';
        qs('#editor').style.color = '';
      }
    }
    function closeEditor(){
      qs('#overlayEditor').style.display='none';
      editingNote=null;
    }

    qs('#saveNote').addEventListener('click', ()=>{
      const title = qs('#noteTitle').value;
      const content = qs('#editor').innerHTML;
      const notebook = qs('#editorNotebook').value || state.notebooks[0].id;
      const snapshot = `${title}::${content}::${notebook}`;
      if(snapshot === lastManualSavedSnapshot){
        animateSaveButton('Esta nota ya est√° guardada', true);
        return;
      }
      animateSaveButton('Guardando...');
      saveCurrentNote({shouldClose:false});
      lastManualSavedSnapshot = snapshot;
      animateSaveButton('Guardado ‚úì');
    });
    qs('#calendarBtn').addEventListener('click', ()=>openCalendarModal());
    qs('#deleteNoteBtn').addEventListener('click', ()=>{
      if(editingNote && confirm('¬øEliminar nota?')){ state.notes = state.notes.filter(n=>n.id!==editingNote.id); saveState(); renderNotes(); refreshNotebookWorkspace(); closeEditor(); }
    });


    const WEEK_NAMES = ['L','M','M','J','V','S','D'];
    let calendarDate = new Date();
    let selectedCalendarDay = null;

    function startOfDay(date){
      return new Date(date.getFullYear(), date.getMonth(), date.getDate());
    }

    function getStableCalendarDate(){
      const fallback = startOfDay(new Date());
      const raw = localStorage.getItem(CALENDAR_STABLE_KEY);
      if(!raw){
        localStorage.setItem(CALENDAR_STABLE_KEY, JSON.stringify({
          anchorDate: fallback.getTime(),
          anchorSavedAt: Date.now()
        }));
        return fallback;
      }
      try{
        const data = JSON.parse(raw);
        if(!data?.anchorDate || !data?.anchorSavedAt) return fallback;
        const elapsedMs = Math.max(0, Date.now() - Number(data.anchorSavedAt));
        const elapsedDays = Math.floor(elapsedMs / 86400000);
        const base = startOfDay(new Date(Number(data.anchorDate)));
        base.setDate(base.getDate() + elapsedDays);
        return base;
      }catch(_e){
        return fallback;
      }
    }

    function saveStableCalendarDate(date){
      const stable = startOfDay(date);
      localStorage.setItem(CALENDAR_STABLE_KEY, JSON.stringify({
        anchorDate: stable.getTime(),
        anchorSavedAt: Date.now()
      }));
    }

    function openCalendarModal(){
      const stableDate = getStableCalendarDate();
      calendarDate = new Date(stableDate);
      selectedCalendarDay = new Date(stableDate);
      renderCalendar();
      qs('#overlayCalendar').style.display = 'flex';
    }

    function closeCalendarModal(){
      qs('#overlayCalendar').style.display = 'none';
    }

    function renderCalendar(){
      const grid = qs('#calendarGrid');
      const year = calendarDate.getFullYear();
      const month = calendarDate.getMonth();
      const locale = getLocaleTag();
      const monthLabel = new Date(year, month, 1).toLocaleDateString(locale, {month:'long', year:'numeric'});
      qs('#calendarTitle').textContent = monthLabel.charAt(0).toUpperCase() + monthLabel.slice(1);
      grid.innerHTML = '';
      WEEK_NAMES.forEach(day=>{
        const wd = document.createElement('div');
        wd.className = 'calendar-weekday';
        wd.textContent = day;
        grid.appendChild(wd);
      });
      const first = new Date(year, month, 1);
      const firstDay = (first.getDay() + 6) % 7;
      const days = new Date(year, month + 1, 0).getDate();
      for(let i=0;i<firstDay;i++){
        const blank = document.createElement('div');
        grid.appendChild(blank);
      }
      for(let day=1; day<=days; day++){
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'calendar-day';
        btn.textContent = day;
        if(
          selectedCalendarDay &&
          selectedCalendarDay.getFullYear() === year &&
          selectedCalendarDay.getMonth() === month &&
          selectedCalendarDay.getDate() === day
        ){
          btn.classList.add('active');
        }
        btn.addEventListener('click', ()=>{
          selectedCalendarDay = new Date(year, month, day);
          saveStableCalendarDate(selectedCalendarDay);
          qsa('.calendar-day').forEach(d=>d.classList.remove('active'));
          btn.classList.add('active');
        });
        grid.appendChild(btn);
      }
    }

    function animateSaveButton(message='Guardado ‚úì', keep=false){
      const btn = qs('#saveNote');
      clearTimeout(saveStatusTimer);
      btn.classList.remove('saving');
      if(message.includes('Guardando')) btn.classList.add('saving');
      else btn.classList.add('saved');
      btn.textContent = message;
      if(!keep){
        saveStatusTimer = setTimeout(()=>{
          btn.classList.remove('saving','saved');
          btn.textContent = 'Guardar';
        }, 1100);
      }
    }

    qs('#calendarPrev').addEventListener('click', ()=>{ calendarDate.setMonth(calendarDate.getMonth()-1); renderCalendar(); });
    qs('#calendarNext').addEventListener('click', ()=>{ calendarDate.setMonth(calendarDate.getMonth()+1); renderCalendar(); });
    qs('#closeCalendar').addEventListener('click', closeCalendarModal);
    qs('#insertCalendarDate').addEventListener('click', ()=>{
      if(!selectedCalendarDay) return alert('Selecciona una fecha');
      const formatted = selectedCalendarDay.toLocaleDateString(getLocaleTag(), { day:'2-digit', month:'long', year:'numeric' });
      insertHtmlAtCursor(`<p><strong>üìÖ ${formatted}</strong></p>`);
      saveCurrentNote({shouldClose:false});
      closeCalendarModal();
    });

    function saveCurrentNote({shouldClose=false} = {}){
      const title = qs('#noteTitle').value;
      const content = qs('#editor').innerHTML;
      const notebook = qs('#editorNotebook').value || state.notebooks[0].id;
      if(editingNote){
        editingNote.title=title;
        editingNote.content=content;
        editingNote.notebook=notebook;
        editingNote.updated=Date.now();
      } else {
        const newNote = {id:uid(),title,content,notebook,updated:Date.now(), created:Date.now(), bgColor:null, textColor:null};
        state.notes.push(newNote);
        editingNote = newNote;
      }
      saveState(); renderNotes(); refreshNotebookWorkspace();
      if(shouldClose){ editingNote=null; closeEditor(); }
    }

    function setupAutosave(){
      const editor = qs('#editor'); const titleEl = qs('#noteTitle');
      let timer; editor.oninput = titleEl.oninput = ()=>{
        clearTimeout(timer);
        timer=setTimeout(()=>saveCurrentNote({shouldClose:false}),700);
      };
    }

    // --- Notebooks CRUD ---
    let editingNotebook=null; let renameOnly=false;
    function openNotebookModal(nb=null,opt={}){
      editingNotebook=nb||null;
      renameOnly=opt.renameOnly||false;
      qs('#overlayNotebook').style.display='flex';
      qs('#nbModalTitle').textContent = nb ? (renameOnly?'Renombrar cuaderno':'Editar cuaderno'):'Nuevo cuaderno';
      qs('#nbName').value = nb?.name||'';
      qs('#nbCoverColor').value = nb?.coverColor || '#f08aba';
      const coverInput = qs('#nbCoverFile');
      coverInput.value = '';
      coverInput.disabled = renameOnly;
    }
    qs('#nbCancel').addEventListener('click', ()=>qs('#overlayNotebook').style.display='none');
    qs('#nbSave').addEventListener('click', async ()=>{
      const name = qs('#nbName').value.trim(); if(!name) return alert('Nombre requerido');
      if(editingNotebook){
        editingNotebook.name=name;
        if(!renameOnly && qs('#nbCoverFile').files[0]) editingNotebook.cover = await fileToDataUrl(qs('#nbCoverFile').files[0]);
        editingNotebook.coverColor = qs('#nbCoverColor').value;
      } else {
        const cover = qs('#nbCoverFile').files[0]? await fileToDataUrl(qs('#nbCoverFile').files[0]):null;
        const coverColor = qs('#nbCoverColor').value;
        state.notebooks.push({id:uid(),name,cover,coverColor});
      }
      saveState(); renderNotebooks(); qs('#overlayNotebook').style.display='none';
    });
    function deleteNotebook(id){
      if(!confirm('Eliminar libreta y sus notas. ¬øContinuar?')) return;
      state.notebooks = state.notebooks.filter(nb=>nb.id!==id);
      state.notes = state.notes.filter(n=>n.notebook!==id);
      saveState(); renderNotebooks(); renderNotes(); refreshNotebookWorkspace();
    }

    function populateNotebookFilters(){
      const sel = qs('#filterNotebook'); const editorSel=qs('#editorNotebook');
      sel.innerHTML='<option value="all">Todas</option>';
      editorSel.innerHTML='';
      state.notebooks.forEach(nb=>{ const o1=document.createElement('option'); o1.value=nb.id; o1.textContent=nb.name; sel.appendChild(o1); const o2=o1.cloneNode(true); editorSel.appendChild(o2); });
    }
    function populateEditorNotebook(){ populateNotebookFilters(); if(editingNote) qs('#editorNotebook').value = editingNote.notebook; }

    function moveNoteToNotebook(noteId, nbId){ const note = state.notes.find(n=>n.id===noteId); if(note){ note.notebook=nbId; saveState(); renderNotes(); refreshNotebookWorkspace(); } }

    // --- Views ---
    function showView(view){
      qs('#view-notes').style.display=view==='notes'?'block':'none';
      qs('#view-cuadernos').style.display=view==='cuadernos'?'block':'none';
      qs('#view-notebook-notes').style.display='none';
      if(view !== 'cuadernos') activeNotebookId = null;
    }
    qsa('.nav-links a').forEach(a=>a.addEventListener('click', e=>{ e.preventDefault(); showView(a.dataset.view); }));

    // --- FAB and quick add binding ---
    qs('#fab').addEventListener('click', ()=>openEditor());
    qs('#openQuickAdd').addEventListener('click', ()=>openEditor());

    // --- Export / Import ---
    qs('#exportBtn').addEventListener('click', ()=>{ const dataStr = JSON.stringify(state,null,2); const blob = new Blob([dataStr], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='digital_notes.json'; a.click(); URL.revokeObjectURL(url); });
    qs('#importFile').addEventListener('change', e=>{ const f = e.target.files[0]; if(!f)return; const reader = new FileReader(); reader.onload = function(ev){ try{ state = JSON.parse(ev.target.result); saveState(); renderNotebooks(); renderNotes(); refreshNotebookWorkspace(); }catch(err){ alert('Archivo inv√°lido'); } }; reader.readAsText(f); });

    // --- Color panel behavior ---
    qs('#openColorPanel').addEventListener('click', ()=>{ qs('#colorPanel').style.display = qs('#colorPanel').style.display === 'none' ? 'block' : 'none'; });
    const updateColorPreview = ()=> {
      const h = qs('#hRange').value, s = qs('#sRange').value, l = qs('#lRange').value, a = qs('#aRange').value;
      qs('#colorPreview').style.background = `hsla(${h}, ${s}%, ${l}%, ${a})`;
    };
    ['hRange','sRange','lRange','aRange'].forEach(id=>qs('#'+id).addEventListener('input', updateColorPreview));
    updateColorPreview();

    qs('#applyBgColor').addEventListener('click', ()=>{
      const bg = qs('#colorPreview').style.background;
      if(editingNote) { editingNote.bgColor=bg; } else {
        // apply to new note preview inside editor
      }
      // apply to editor background for visual feedback
      qs('#editor').style.background = bg;
      saveCurrentNote({shouldClose:false});
    });

    qs('#textColorTool').addEventListener('click', ()=>{
      qs('#textColorToolPicker').click();
    });
    qs('#textColorToolPicker').addEventListener('input', (e)=>{
      const color = e.target.value;
      document.execCommand('foreColor', false, color);
      qs('#editor').focus();
      saveCurrentNote({shouldClose:false});
    });

    // Quick palette generation
    const quickColors = ['#fff5fb','#ffd9ec','#f8d6ff','#ffe7f2','#fddaf0','#ffe0d2','#f0dbff','#e8d9ff','#f8cfe5','#ffd6e8'];
    function renderQuickPalette(){
      const container = qs('#quickPalette'); container.innerHTML='';
      quickColors.forEach(c=>{
        const btn = document.createElement('button'); btn.style.background=c;
        btn.addEventListener('click', ()=>{ qs('#editor').style.background=c; if(editingNote) editingNote.bgColor=c; saveCurrentNote({shouldClose:false}); });
        container.appendChild(btn);
      });
    }
    renderQuickPalette();

    // --- Insert image into editor ---
    qs('#insertImageBtn').addEventListener('click', ()=> qs('#noteImageFile').click());
    qs('#noteImageFile').addEventListener('change', async (e)=>{
      const f = e.target.files[0]; if(!f) return;
      const dataUrl = await fileToDataUrl(f);
      // insert at caret position in contenteditable
      insertHtmlAtCursor(`<img src="${dataUrl}" class="note-img" style="width:70%;display:block;margin:8px 0;position:relative;left:0px;top:0px;" />`);
      // autosave will pick up changes
      saveCurrentNote({shouldClose:false});
      e.target.value = '';
    });

    function insertHtmlAtCursor(html) {
      const sel = window.getSelection();
      if (!sel || !sel.rangeCount) {
        qs('#editor').insertAdjacentHTML('beforeend', html);
        return;
      }
      const range = sel.getRangeAt(0);
      range.deleteContents();
      const el = document.createElement('div');
      el.innerHTML = html;
      const frag = document.createDocumentFragment();
      let node, lastNode;
      while ((node = el.firstChild)) {
        lastNode = frag.appendChild(node);
      }
      range.insertNode(frag);
      // move cursor after inserted node
      if (lastNode) {
        range.setStartAfter(lastNode);
        range.collapse(true);
        sel.removeAllRanges();
        sel.addRange(range);
      }
    }

    function animateTap(el){
      if(!el) return;
      el.classList.remove('tap-anim');
      void el.offsetWidth;
      el.classList.add('tap-anim');
    }

    function changeSelectionFontSize(step){
      const size = step > 0 ? 5 : 2;
      document.execCommand('fontSize', false, size);
      qs('#editor').focus();
      saveCurrentNote({shouldClose:false});
    }

    qs('#fontIncrease').addEventListener('click', ()=>changeSelectionFontSize(1));
    qs('#fontDecrease').addEventListener('click', ()=>changeSelectionFontSize(-1));

    const compactBgColors = ['#fff8fc','#ffeef8','#ffe4f3','#ffdaf0','#f8ecff','#efe2ff','#e6f0ff','#e7fff7','#fdf7e3','#ffffff'];
    function renderCompactPalette(){
      const wrap = qs('#compactColorGrid');
      if(!wrap) return;
      wrap.innerHTML = '';
      compactBgColors.forEach(color=>{
        const sw = document.createElement('button');
        sw.type = 'button';
        sw.style.background = color;
        sw.title = color;
        sw.addEventListener('click', ()=>{
          qs('#editor').style.background = color;
          if(editingNote) editingNote.bgColor = color;
          saveCurrentNote({shouldClose:false});
        });
        wrap.appendChild(sw);
      });
    }
    qs('#toggleCompactPalette').addEventListener('click', ()=>{
      const panel = qs('#compactColorPalette');
      panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
      qs('#colorPanel').style.display = 'none';
    });

    const drawingBoard = qs('#drawingBoard');
    const templatePanel = qs('#templatePanel');
    const templateGalleryEditor = qs('#templateGalleryEditor');
    function setTemplateSession(isOpen){
      templatePanel.style.display = isOpen ? 'block' : 'none';
      templateGalleryEditor.style.display = isOpen ? 'block' : 'none';
      qs('#insertTemplateBtn').setAttribute('aria-pressed', String(isOpen));
    }
    qs('#insertTemplateBtn').addEventListener('click', ()=>{
      const open = templatePanel.style.display !== 'block';
      setTemplateSession(open);
      drawingBoard.style.display = 'none';
    });

    function insertAssetBlock({src, label, width='95%', template=false}){
      qs('#editor').focus();
      const safeLabel = label || 'Elemento';
      insertHtmlAtCursor(`
        <figure class="note-asset-block">
          <figcaption>${safeLabel}</figcaption>
          <img src="${src}" class="note-img${template ? " template-inline" : ""}" style="width:${width};display:block;margin:0 auto;position:relative;left:0;top:0;" alt="${safeLabel}" />
        </figure>
        <p><br></p>
      `);
    }

    qsa('.template-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const src = btn.dataset.template;
        insertAssetBlock({ src, label:'Plantilla en la nota', width:'96%' , template:true });
        saveCurrentNote({shouldClose:false});
        setTemplateSession(false);
      });
    });

    const drawCanvas = qs('#drawCanvas');
    const drawCtx = drawCanvas.getContext('2d');
    let isDrawing = false;
    let eraserOn = false;
    function drawPoint(e){
      const rect = drawCanvas.getBoundingClientRect();
      const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
      const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
      return {x, y};
    }
    function setBrush(){
      const brush = qs('#drawBrush').value;
      const size = Number(qs('#drawSize').value);
      drawCtx.lineWidth = brush === 'marker' ? size * 2 : size;
      drawCtx.lineCap = brush === 'square' ? 'butt' : 'round';
      drawCtx.globalAlpha = brush === 'marker' ? 0.45 : 1;
      drawCtx.strokeStyle = eraserOn ? '#ffffff' : qs('#drawColor').value;
    }
    function startDraw(e){
      isDrawing = true;
      setBrush();
      const p = drawPoint(e);
      drawCtx.beginPath();
      drawCtx.moveTo(p.x, p.y);
      e.preventDefault();
    }
    function moveDraw(e){
      if(!isDrawing) return;
      const p = drawPoint(e);
      drawCtx.lineTo(p.x, p.y);
      drawCtx.stroke();
      e.preventDefault();
    }
    function endDraw(){ isDrawing = false; drawCtx.closePath(); }
    drawCtx.fillStyle = '#ffffff';
    drawCtx.fillRect(0,0,drawCanvas.width,drawCanvas.height);
    drawCanvas.addEventListener('mousedown', startDraw);
    drawCanvas.addEventListener('mousemove', moveDraw);
    window.addEventListener('mouseup', endDraw);
    drawCanvas.addEventListener('touchstart', startDraw, {passive:false});
    drawCanvas.addEventListener('touchmove', moveDraw, {passive:false});
    drawCanvas.addEventListener('touchend', endDraw);

    qs('#drawEraser').addEventListener('click', ()=>{ eraserOn = !eraserOn; });
    qs('#clearDrawCanvas').addEventListener('click', ()=>{
      drawCtx.clearRect(0,0,drawCanvas.width,drawCanvas.height);
      drawCtx.fillStyle = '#ffffff';
      drawCtx.fillRect(0,0,drawCanvas.width,drawCanvas.height);
    });
    qs('#saveDrawingBtn').addEventListener('click', ()=>{
      const dataUrl = drawCanvas.toDataURL('image/png');
      insertAssetBlock({ src:dataUrl, label:'Dibujo en la nota', width:'90%' });
      saveCurrentNote({shouldClose:false});
    });

    const drawFullscreenOverlay = qs('#drawFullscreenOverlay');
    const drawFsCanvas = qs('#drawFullscreenCanvas');
    const drawFsCtx = drawFsCanvas.getContext('2d');
    let drawFsActive = false;
    let drawFsEraser = false;

    function drawFsPoint(evt){
      const rect = drawFsCanvas.getBoundingClientRect();
      const point = evt.touches ? evt.touches[0] : evt;
      const scaleX = drawFsCanvas.width / rect.width;
      const scaleY = drawFsCanvas.height / rect.height;
      return { x:(point.clientX - rect.left) * scaleX, y:(point.clientY - rect.top) * scaleY };
    }

    function setFsBrush(){
      const brush = qs('#drawFsBrush').value;
      const size = Number(qs('#drawFsSize').value);
      drawFsCtx.lineWidth = brush === 'marker' ? size * 2 : size;
      drawFsCtx.lineCap = brush === 'square' ? 'butt' : 'round';
      drawFsCtx.globalAlpha = brush === 'marker' ? 0.4 : 1;
      drawFsCtx.strokeStyle = drawFsEraser ? '#ffffff' : qs('#drawFsColor').value;
    }

    function resizeFsCanvas(){
      const old = drawFsCanvas.toDataURL('image/png');
      const ratio = window.devicePixelRatio || 1;
      const rect = drawFsCanvas.getBoundingClientRect();
      drawFsCanvas.width = Math.max(800, Math.floor(rect.width * ratio));
      drawFsCanvas.height = Math.max(460, Math.floor(rect.height * ratio));
      const temp = new Image();
      temp.onload = ()=> drawFsCtx.drawImage(temp, 0, 0, drawFsCanvas.width, drawFsCanvas.height);
      temp.src = old;
    }

    function openFullscreenDraw(){
      drawFullscreenOverlay.style.display = 'flex';
      setTimeout(resizeFsCanvas, 40);
    }

    function closeFullscreenDraw(){
      drawFullscreenOverlay.style.display = 'none';
      drawFsActive = false;
    }

    function fsStart(e){
      drawFsActive = true;
      setFsBrush();
      const p = drawFsPoint(e);
      drawFsCtx.beginPath();
      drawFsCtx.moveTo(p.x,p.y);
      e.preventDefault();
    }
    function fsMove(e){
      if(!drawFsActive) return;
      const p = drawFsPoint(e);
      drawFsCtx.lineTo(p.x,p.y);
      drawFsCtx.stroke();
      e.preventDefault();
    }
    function fsEnd(){ drawFsActive = false; drawFsCtx.closePath(); }

    drawFsCtx.fillStyle = '#ffffff';
    drawFsCtx.fillRect(0,0,drawFsCanvas.width,drawFsCanvas.height);
    drawFsCanvas.addEventListener('mousedown', fsStart);
    drawFsCanvas.addEventListener('mousemove', fsMove);
    window.addEventListener('mouseup', fsEnd);
    drawFsCanvas.addEventListener('touchstart', fsStart, {passive:false});
    drawFsCanvas.addEventListener('touchmove', fsMove, {passive:false});
    drawFsCanvas.addEventListener('touchend', fsEnd);

    qs('#openFullscreenDraw').addEventListener('click', openFullscreenDraw);
    qs('#closeFullscreenDraw').addEventListener('click', closeFullscreenDraw);
    qs('#drawFsEraser').addEventListener('click', ()=>{ drawFsEraser = !drawFsEraser; });
    qs('#drawFsClear').addEventListener('click', ()=>{
      drawFsCtx.clearRect(0,0,drawFsCanvas.width,drawFsCanvas.height);
      drawFsCtx.fillStyle = '#ffffff';
      drawFsCtx.fillRect(0,0,drawFsCanvas.width,drawFsCanvas.height);
    });
    qs('#drawFsSave').addEventListener('click', ()=>{
      const dataUrl = drawFsCanvas.toDataURL('image/png');
      insertAssetBlock({ src:dataUrl, label:'Dibujo en pantalla completa', width:'95%' });
      saveCurrentNote({shouldClose:false});
      closeFullscreenDraw();
    });

    function attachCanvasDrawing(canvasEl, options){
      const ctx = canvasEl.getContext('2d');
      let drawing = false;
      let eraser = false;
      const getPoint = evt=>{
        const rect = canvasEl.getBoundingClientRect();
        const point = evt.touches ? evt.touches[0] : evt;
        const scaleX = canvasEl.width / rect.width;
        const scaleY = canvasEl.height / rect.height;
        return {x:(point.clientX - rect.left) * scaleX, y:(point.clientY - rect.top) * scaleY};
      };
      const setBrush = ()=>{
        const brush = qs(options.brush).value;
        const size = Number(qs(options.size).value);
        ctx.lineWidth = brush === 'marker' ? size * 2 : size;
        ctx.lineCap = brush === 'square' ? 'butt' : 'round';
        ctx.globalAlpha = brush === 'marker' ? 0.45 : 1;
        ctx.strokeStyle = eraser ? 'rgba(0,0,0,0)' : qs(options.color).value;
        ctx.globalCompositeOperation = eraser ? 'destination-out' : 'source-over';
      };
      const start = e=>{ drawing=true; setBrush(); const p=getPoint(e); ctx.beginPath(); ctx.moveTo(p.x,p.y); e.preventDefault(); };
      const move = e=>{ if(!drawing) return; const p=getPoint(e); ctx.lineTo(p.x,p.y); ctx.stroke(); e.preventDefault(); };
      const end = ()=>{ drawing=false; ctx.closePath(); };
      canvasEl.addEventListener('mousedown', start);
      canvasEl.addEventListener('mousemove', move);
      canvasEl.addEventListener('touchstart', start, {passive:false});
      canvasEl.addEventListener('touchmove', move, {passive:false});
      canvasEl.addEventListener('touchend', end);
      window.addEventListener('mouseup', end);
      qs(options.eraser).addEventListener('click', ()=>{ eraser = !eraser; });
      qs(options.clear).addEventListener('click', ()=>ctx.clearRect(0,0,canvasEl.width,canvasEl.height));
      return { ctx, clear:()=>ctx.clearRect(0,0,canvasEl.width,canvasEl.height) };
    }

    const templateCanvas = qs('#templateDrawCanvas');
    const templateBgImage = qs('#templateBgImage');
    const overlayTemplateEditor = qs('#overlayTemplateEditor');
    let templatePad = null;

    function ensureTemplatePad(){
      if(templatePad) return templatePad;
      templatePad = attachCanvasDrawing(templateCanvas, {
        color:'#templateDrawColor',
        size:'#templateDrawSize',
        brush:'#templateDrawBrush',
        eraser:'#templateEraserBtn',
        clear:'#templateClearBtn'
      });
      return templatePad;
    }

    function fitTemplateCanvas(){
      const wrap = templateCanvas.parentElement.getBoundingClientRect();
      const ratio = window.devicePixelRatio || 1;
      templateCanvas.width = Math.floor(wrap.width * ratio);
      templateCanvas.height = Math.floor(wrap.height * ratio);
    }

    function openTemplateEditor(template){
      qs('#templateEditorTitle').textContent = `Editor: ${template.name}`;
      templateBgImage.src = template.src;
      overlayTemplateEditor.style.display = 'flex';
      fitTemplateCanvas();
      ensureTemplatePad().clear();
    }

    qs('#templateSaveBtn').addEventListener('click', ()=>{
      const selectedTemplate = templateBgImage.getAttribute('src');
      if(!selectedTemplate) return;
      const composedCanvas = document.createElement('canvas');
      composedCanvas.width = templateCanvas.width;
      composedCanvas.height = templateCanvas.height;
      const composedCtx = composedCanvas.getContext('2d');
      const baseImage = new Image();
      baseImage.onload = ()=>{
        composedCtx.drawImage(baseImage, 0, 0, composedCanvas.width, composedCanvas.height);
        composedCtx.drawImage(templateCanvas, 0, 0, composedCanvas.width, composedCanvas.height);
        const dataUrl = composedCanvas.toDataURL('image/png');
        insertAssetBlock({ src:dataUrl, label:'Plantilla en la nota', width:'96%' , template:true });
        saveCurrentNote({shouldClose:false});
        overlayTemplateEditor.style.display = 'none';
      };
      baseImage.src = selectedTemplate;
    });

    qs('#templateCloseBtn').addEventListener('click', ()=>overlayTemplateEditor.style.display='none');
    window.addEventListener('resize', ()=>{
      if(drawFullscreenOverlay.style.display === 'flex') resizeFsCanvas();
      if(overlayTemplateEditor.style.display === 'flex') fitTemplateCanvas();
    });

    // --- Rich text tools ---
    qsa('.toolbar [data-cmd]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.execCommand(btn.dataset.cmd, false, null);
        qs('#editor').focus();
      });
    });

    qsa('.toolbar [data-align]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const align = btn.dataset.align;
        const cmd = align === 'left' ? 'justifyLeft' : align === 'center' ? 'justifyCenter' : 'justifyRight';
        document.execCommand(cmd, false, null);
        qs('#editor').focus();
      });
    });

    qs('#fontSelect').addEventListener('change', (e)=>{
      if(!e.target.value) return;
      document.execCommand('fontName', false, e.target.value);
      qs('#editor').focus();
      e.target.value = '';
    });

    qs('#emojiSelect').addEventListener('change', (e)=>{
      if(!e.target.value) return;
      insertHtmlAtCursor(`${e.target.value} `);
      saveCurrentNote({shouldClose:false});
      e.target.value = '';
    });

    qs('#applyHighlight').addEventListener('click', ()=>{
      const color = qs('#highlightColor').value;
      document.execCommand('hiliteColor', false, color);
      qs('#editor').focus();
    });

    qs('#insertChecklist').addEventListener('click', ()=>{
      insertHtmlAtCursor(`<div><label><input type="checkbox" /> Tarea</label></div>`);
      saveCurrentNote({shouldClose:false});
    });

    // --- Image controls ---
    const imageControls = qs('#imageControls');
    const imageSize = qs('#imageSize');
    const imageRotate = qs('#imageRotate');
    const imageAlign = qs('#imageAlign');
    const pinImageBtn = qs('#pinImageBtn');

    qs('#editor').addEventListener('click', (e)=>{
      const target = e.target;
      if(target && target.tagName === 'IMG' && target.classList.contains('template-inline')){
        e.preventDefault();
        e.stopPropagation();
        qs('#templatePreviewImage').src = target.src;
        qs('#overlayTemplatePreview').style.display = 'flex';
        return;
      }
      if(target && target.tagName === 'IMG'){
        qsa('#editor img').forEach(img=>img.classList.remove('selected'));
        target.classList.add('selected');
        currentImage = target;
        imageControls.style.display = 'flex';
        const width = parseInt(target.style.width || '70', 10);
        imageSize.value = Number.isNaN(width) ? 70 : width;
        const rotateMatch = target.style.transform.match(/rotate\(([-\d.]+)deg\)/);
        imageRotate.value = rotateMatch ? rotateMatch[1] : 0;
        const alignValue = target.dataset.align || 'left';
        imageAlign.value = alignValue;
        pinImageBtn.textContent = target.dataset.pinned === 'true' ? 'Desfijar imagen' : 'Fijar imagen';
      } else {
        qsa('#editor img').forEach(img=>img.classList.remove('selected'));
        currentImage = null;
        imageControls.style.display = 'none';
        pinImageBtn.textContent = 'Fijar imagen';
      }
    });

    let dragImageState = null;
    qs('#editor').addEventListener('pointerdown', (e)=>{
      const target = e.target;
      if(!(target && target.tagName === 'IMG')) return;
      if(target.dataset.pinned === 'true') return;
      dragImageState = {el: target, startX: e.clientX, startY: e.clientY, left: parseFloat(target.style.left || 0), top: parseFloat(target.style.top || 0)};
      target.setPointerCapture(e.pointerId);
    });

    qs('#editor').addEventListener('pointermove', (e)=>{
      if(!dragImageState) return;
      const dx = e.clientX - dragImageState.startX;
      const dy = e.clientY - dragImageState.startY;
      dragImageState.el.style.left = `${dragImageState.left + dx}px`;
      dragImageState.el.style.top = `${dragImageState.top + dy}px`;
    });

    qs('#editor').addEventListener('pointerup', ()=>{
      if(!dragImageState) return;
      saveCurrentNote({shouldClose:false});
      dragImageState = null;
    });

    qs('#editor').addEventListener('change', (e)=>{
      const target = e.target;
      if(target && target.matches('input[type="checkbox"]')){
        if(target.checked){
          target.setAttribute('checked', 'checked');
        } else {
          target.removeAttribute('checked');
        }
        saveCurrentNote({shouldClose:false});
      }
    });

    qs('#editor').addEventListener('click', (e)=>{
      const target = e.target;
      if(target && target.matches('input[type="checkbox"]')){
        if(target.checked){
          target.setAttribute('checked', 'checked');
        } else {
          target.removeAttribute('checked');
        }
        saveCurrentNote({shouldClose:false});
      }
    });

    qs('#scrollUpBtn').addEventListener('click', ()=>{
      qs('#editor').scrollBy({top:-240, behavior:'smooth'});
    });

    qs('#scrollDownBtn').addEventListener('click', ()=>{
      qs('#editor').scrollBy({top:240, behavior:'smooth'});
    });

    function applyImageAlign(value){
      if(!currentImage) return;
      currentImage.dataset.align = value;
      currentImage.style.display = 'block';
      currentImage.style.marginLeft = value === 'right' ? 'auto' : '0';
      currentImage.style.marginRight = value === 'left' ? 'auto' : '0';
      if(value === 'center'){
        currentImage.style.marginLeft = 'auto';
        currentImage.style.marginRight = 'auto';
      }
    }

    imageSize.addEventListener('input', ()=>{
      if(!currentImage) return;
      currentImage.style.width = `${imageSize.value}%`;
      saveCurrentNote({shouldClose:false});
    });

    imageRotate.addEventListener('input', ()=>{
      if(!currentImage) return;
      currentImage.style.transform = `rotate(${imageRotate.value}deg)`;
      saveCurrentNote({shouldClose:false});
    });

    imageAlign.addEventListener('change', ()=>{
      if(!currentImage) return;
      applyImageAlign(imageAlign.value);
      saveCurrentNote({shouldClose:false});
    });


    pinImageBtn.addEventListener('click', ()=>{
      if(!currentImage) return;
      const pinned = currentImage.dataset.pinned === 'true';
      currentImage.dataset.pinned = pinned ? 'false' : 'true';
      pinImageBtn.textContent = pinned ? 'Fijar imagen' : 'Desfijar imagen';
      saveCurrentNote({shouldClose:false});
    });

    qs('#removeImageBtn').addEventListener('click', ()=>{
      if(!currentImage) return;
      currentImage.remove();
      currentImage = null;
      imageControls.style.display = 'none';
      saveCurrentNote({shouldClose:false});
    });


    qs('#fullscreenEditorBtn').addEventListener('click', ()=>{
      const modal = qs('#editorModal');
      modal.classList.toggle('fullscreen');
      qs('#fullscreenEditorBtn').textContent = modal.classList.contains('fullscreen') ? 'üóó Salir de pantalla completa' : '‚õ∂ Pantalla completa';
    });

    qs('#templatePreviewClose').addEventListener('click', ()=>qs('#overlayTemplatePreview').style.display='none');
    qs('#templatePreviewEdit').addEventListener('click', ()=>{
      qs('#overlayTemplatePreview').style.display='none';
      const imgSrc = qs('#templatePreviewImage').src;
      const found = TEMPLATE_ITEMS.find(t=>imgSrc.includes(t.src));
      openTemplateEditor(found || {name:'Plantilla', src:imgSrc});
    });

    qs('#openSettingsBtn').addEventListener('click', ()=>{
      updateSettingsPanel();
      qs('#overlaySettings').style.display = 'flex';
    });
    qs('#closeSettingsBtn').addEventListener('click', ()=>qs('#overlaySettings').style.display='none');
    qs('#logoutBtn').addEventListener('click', ()=>{
      qs('#overlaySettings').style.display='none';
      clearSession();
    });

    // --- Utility: close overlays when clicking outside modal content ---
    document.querySelectorAll('.overlay').forEach(ov=>{
      ov.addEventListener('click', e=>{
        if(e.target === ov){ ov.style.display='none'; editingNote=null; }
      });
    });


    async function requestMultimediaAccess(){
      if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
        alert('Tu navegador no soporta solicitud de multimedia.');
        return;
      }
      const wants = confirm('¬øQuieres permitir acceso solo a fotos/c√°mara para enriquecer tus notas?');
      if(!wants) return;
      try {
        const stream = await navigator.mediaDevices.getUserMedia({video:true,audio:false});
        stream.getTracks().forEach(track=>track.stop());
        alert('Acceso a fotos/c√°mara habilitado.');
      } catch (err) {
        alert('No se pudo activar el acceso multimedia. Puedes intentarlo luego desde tu navegador.');
      }
    }

    async function maybeShowOnboarding(){
      if(localStorage.getItem(ONBOARDING_KEY)) return;
      qs('#overlayTutorial').style.display='flex';
      await requestMultimediaAccess();
    }

    // --- Init ---
    function init(){
      loadState();
      state.notebooks = state.notebooks.map(nb=>({coverColor:'#f08aba', ...nb}));
      renderNotebooks();
      renderNotes();
      renderTemplateGallery();
      showView('notes');
      // ensure editor notebook select exists
      populateEditorNotebook();
      renderCompactPalette();
      maybeShowOnboarding();
      bootstrapAuth();

      qsa('button, .btn, .toolbar button, .icon-btn').forEach(el=>{
        el.addEventListener('click', ()=>animateTap(el));
      });
    }
    init();

    // Expose some functions for console debugging (optional)
    window._dn = { state, saveState, renderNotes, renderNotebooks };

  </script>
</body>
</html>
